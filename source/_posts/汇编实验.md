---
title: 汇编实验
tags: [汇编]
date: 2017-01-15 12:22
---
实验报告题目编写一个可以自行启动的计算机，不需要在现有操作系统环境中运行的程序实现 显示时间、修改时间、变色、重启、进入操作系统
<!-- more -->
<link rel="stylesheet" type="text/css" href="http://static.blog.csdn.net/css/csdn_blog_detail.min.css">
<div class="markdown_views"><h1 id="实验报告"><center>实验报告</center></h1>
<h2 id="题目">题目</h2>
<p>编写一个可以自行启动的计算机，不需要在现有操作系统环境中运行的程序</p>
<h2 id="实验内容">实验内容</h2>
<ul>
<li>裸机编程，不需要操作系统</li>
<li>能够实现查看系统时间，修改系统时间，重启，进入硬盘操作系统等功能</li>
</ul>
<h2 id="实验要求">实验要求</h2>
<p>提交源码，实验报告</p>
<h2 id="实验原理">实验原理</h2>
<p>系统启动初始化完成后最终调用19h，该中断读取软盘的第一扇区或硬盘的第一扇区到0:7c00开始的512个字节的内存空间中，并将 CS:IP 指向0:7C00h执行</p>
<h2 id="实验步骤">实验步骤</h2>
<p>实验主要可以分为两部分：</p>
<ul>
<li>主引导程序，存在于软盘第0扇区，由BIOS的19h中断读取到0:7c00开始的内存单元中，并执行0:7c00的第一行代码。这一段的任务是将软盘1,2扇区的数据读入内存，并执行。（这里读入到了0800：0开始的内存中）</li>
<li>系统程序，存放所有运行所需的程序和子程序</li>
</ul>
<h2 id="实验环境">实验环境</h2>
<ul>
<li>RadASM</li>
<li>VMware Workstation Pro(Windows XP操作系统虚拟机)</li>
<li>BOOTICEx64</li>
</ul>
<h2 id="设计细节及程序讲解">设计细节及程序讲解</h2>
<h3 id="设计细节">设计细节</h3>
<ul>
<li><p>系统程序启动后，首先打印系统菜单，即多个字符串，打印完毕后，调用int16h中断，等待用户输入，输入只有1~5是有效的，其他输入不会被接受，五个数字对应的功能分别是</p>
<blockquote>
<p>1 查看系统时间 <br>
  2 修改系统时间 <br>
  3 重启系统 <br>
  4 进入磁盘系统 <br>
  5 改变颜色</br></br></br></br></p>
</blockquote></li>
<li><p>输入编号进入对应功能</p></li>
<li><p>查看系统时间 <br>
首先进行清屏操作，然后通过端口读取CMOS的不同存储地址的信息得到系统时间，并居中显示。 <br>
同样具有按下<strong>5键</strong>改变颜色的功能，在循环刷新时间的过程中判断输入即可。因为一直在循环刷新时间所以按下5键改变颜色时，刷新速度会非常快，出现颜色闪烁的效果 <br>
按下q键返回主菜单，实现方法是跳转到程序开头处，实际上相当于重新显示了菜单</br></br></br></p></li>
<li><p>修改系统时间 <br>
首先进行清屏操作，并显示提示输入格式的字符串 <br>
用户键盘进行输入，将输入存入预先申请的内存空间的同时，在屏幕的左上角对输入进行显示，这是通过写入显存实现的 <br>
读取用户输入完毕后，进行ASCII与BCD码的转换，存入另一段预先申请的内存空间 <br>
转换完毕后，通过端口将参数送入CMOS，修改时间 <br>
修改完毕后，调用显示时间函数，立刻显示了修改后的时间（此时具有按下<strong>5键</strong>改变颜色的功能，闪烁） <br>
此时，可以按下<strong>q键</strong>返回主界面</br></br></br></br></br></br></p></li>
<li><p>重启系统 <br>
通过重写 CS:IP 为0ffffh：0000h，重新启动系统</br></p></li>
<li><p>进入磁盘操作系统 <br>
通过调用int13h中断的2号功能实现的，具体做法是初始化内存地址并设置好用于启动硬盘系统的参数，将硬盘系统的引导写入0000:700c，并置CS：IP为0000:700c，从此处执行硬盘系统的引导程序，即可进入硬盘操作系统</br></p></li>
<li><p>修改颜色 <br>
当能捕捉到5键时，进入改变颜色函数，将显存部分颜色位进行修改</br></p></li>
</ul>
<h3 id="代码讲解">代码讲解</h3>
<ul>
<li>系统启动，显示菜单</li>
</ul>
<pre class="prettyprint"><code class=" hljs vbnet">start:
  jmp sys_start

 ;菜单选项字符串(menuoptions)
mo0 db <span class="hljs-comment">'A Simple System Meum',0</span>
mo1 db <span class="hljs-comment">'1. Show System Time',0</span>
mo2 db <span class="hljs-comment">'2. Set System Time',0</span>
mo3 db <span class="hljs-comment">'3. Restart System',0</span>
mo4 db <span class="hljs-comment">'4. Go Disk System',0</span>
mo5 db <span class="hljs-comment">'Created By ChickSheep',0</span>

 ;函数偏移
s_function dw showtime,settime,restart_sys,go_disksys
sys_start:
  mov ax,run_sys
  mov ds,ax
  <span class="hljs-keyword">call</span> Clearall                ;系统启动时先执行清屏操作

  ;显示菜单
show_meum:
  ;设定显示的行列数
  mov cl,<span class="hljs-number">01</span>h                  ;设定颜色，初始为蓝色
  mov dl,<span class="hljs-number">30</span>                   ;初始化列数

  mov dh,<span class="hljs-number">9</span>                    ;初始化行数
  mov si,offset mo0           ;定位到字符串mo0偏移
  <span class="hljs-keyword">call</span> show_str

  mov dh,<span class="hljs-number">10</span>                   ;初始化行数
  mov si,offset mo1           ;定位到字符串mo1偏移
  <span class="hljs-keyword">call</span> show_str

  mov dh,<span class="hljs-number">11</span>                   ;初始化行数
  mov si,offset mo2           ;定位到字符串mo2偏移
  <span class="hljs-keyword">call</span> show_str

  mov dh,<span class="hljs-number">12</span>                   ;初始化行数
  mov si,offset mo3           ;定位到字符串mo3偏移
  <span class="hljs-keyword">call</span> show_str

  mov dh,<span class="hljs-number">13</span>                   ;初始化行数
  mov si,offset mo4           ;定位到字符串mo4偏移
  <span class="hljs-keyword">call</span> show_str

  mov dh,<span class="hljs-number">14</span>                   ;初始化行数
  mov si,offset mo5           ;定位到字符串mo5偏移
  <span class="hljs-keyword">call</span> show_str</code></pre>
<ul>
<li>监测用户输入</li>
</ul>
<pre class="prettyprint"><code class=" hljs perl"> sys_input:
  mov ah,<span class="hljs-number">00</span>h
  <span class="hljs-keyword">int</span> <span class="hljs-number">16</span>h                        ;调用<span class="hljs-keyword">int</span> <span class="hljs-number">16</span>h中断<span class="hljs-number">0</span>号功能，查看键盘输入，为阻塞状态
  mov bx,<span class="hljs-number">0</span>
  mov bl,al                      ;将键盘的ASCII码存入bl
  mov al,<span class="hljs-number">30</span>H
  <span class="hljs-sub"><span class="hljs-keyword">sub</span> bl,al                      ;</span>将得到的ASCII码转换为数字
  cmp bx,<span class="hljs-number">1</span>                       ;若小于<span class="hljs-number">1</span>则返回等待输入
  jb short sys_input
  cmp bx,<span class="hljs-number">5</span>
  ja short sys_input             ;若大于<span class="hljs-number">5</span>则返回等待输入
  cmp bx,<span class="hljs-number">5</span>                       ;若为<span class="hljs-number">1</span>~<span class="hljs-number">4</span>,则进入选择功能函数部分
  jne func
  call changecolor               ;若等于<span class="hljs-number">5</span>则改变颜色
  jmp sys_input                  ;结果处理完毕，返回监测输入

 func:
  call Clearall                  ;执行各个指令前先清屏
  <span class="hljs-sub"><span class="hljs-keyword">sub</span> bx,1
  add bx,bx                      ;</span>得到对应功能的函数偏移值
  call s_function[bx]            ;进入功能函数
  call Clearall                  ;功能执行完毕后，清屏，等待重新显示主界面
  jmp show_meum</code></pre>
<ul>
<li>显示时间</li>
</ul>
<pre class="prettyprint"><code class=" hljs avrasm">showtime proc                   <span class="hljs-comment">;显示时间的函数</span>
  <span class="hljs-keyword">jmp</span> short showtime1
 s1:
    db <span class="hljs-number">9</span>,<span class="hljs-number">8</span>,<span class="hljs-number">7</span>,<span class="hljs-number">4</span>,<span class="hljs-number">2</span>,<span class="hljs-number">0</span>              <span class="hljs-comment">;CMOS中时间参数的存储位置</span>
 s2:
    db <span class="hljs-string">'/'</span>,<span class="hljs-string">'/'</span>,<span class="hljs-string">' '</span>,<span class="hljs-string">':'</span>,<span class="hljs-string">':'</span>,<span class="hljs-string">' '</span>  <span class="hljs-comment">;时间参数分隔符号</span>

 showtime1:
    <span class="hljs-keyword">mov</span> cx,<span class="hljs-number">6</span>                    <span class="hljs-comment">;CX=6</span>
    <span class="hljs-keyword">mov</span> bx,offset s1            <span class="hljs-comment">;BX指向s,  s为70端口每次所需要的入口参数的首地址</span>
    <span class="hljs-keyword">mov</span> si,offset s2            <span class="hljs-comment">;SI指向s1, s1为显示格式的分隔符号</span>
    <span class="hljs-keyword">mov</span> di,<span class="hljs-number">0</span>                    <span class="hljs-comment">;屏幕定位下标DI，初始为0，运行中自增</span>
 showtime2:
    <span class="hljs-keyword">push</span> cx                     <span class="hljs-comment">;保存循环次数</span>
    <span class="hljs-keyword">mov</span> al,ds:[bx]              <span class="hljs-comment">;取当前需要的70端口的入口参数</span>
    <span class="hljs-keyword">mov</span> dl,ds:[si]              <span class="hljs-comment">;取当前需要的分隔符号</span>
    <span class="hljs-keyword">out</span> <span class="hljs-number">70</span>h,al                  <span class="hljs-comment">;al-&gt;PORT 70,指示要访问单元的地址</span>
    <span class="hljs-keyword">in</span> al,<span class="hljs-number">71</span>h                   <span class="hljs-comment">;PORT 71-&gt;al，读出数据</span>
    <span class="hljs-keyword">mov</span> ah,al                   
    <span class="hljs-keyword">mov</span> cl,<span class="hljs-number">4</span>    
    shr ah,cl                   <span class="hljs-comment">;ah取右移取高四位</span>
    <span class="hljs-keyword">and</span> al,<span class="hljs-number">00001111</span>b            <span class="hljs-comment">;al取低四位   </span>
    <span class="hljs-keyword">add</span> ah,<span class="hljs-number">30</span>h
    <span class="hljs-keyword">add</span> al,<span class="hljs-number">30</span>h                  <span class="hljs-comment">;数字转ASCII,相当于将十位与个位数分离，并转换为字符(BCD-&gt;两位ASCII)</span>
    <span class="hljs-keyword">mov</span> bp,<span class="hljs-number">0</span>b800h               <span class="hljs-comment">;定位到显存位置</span>
    <span class="hljs-keyword">mov</span> es,bp
    <span class="hljs-keyword">mov</span> byte ptr es:[<span class="hljs-number">1980</span>+di],ah
    <span class="hljs-keyword">mov</span> byte ptr es:[<span class="hljs-number">1982</span>+di],al
    <span class="hljs-keyword">mov</span> byte ptr es:[<span class="hljs-number">1984</span>+di],dl<span class="hljs-comment">;送B800显示</span>
    <span class="hljs-keyword">inc</span> bx
    <span class="hljs-keyword">inc</span> si                      <span class="hljs-comment">;2个缓冲区指针分别加1,指向下一个入口参数以及分隔符</span>
    <span class="hljs-keyword">add</span> di,<span class="hljs-number">6</span>                    <span class="hljs-comment">;每次显示3个字符,加偏移为3*2</span>
    <span class="hljs-keyword">pop</span> cx                      <span class="hljs-comment">;恢复当前计数</span>
    loop showtime2              <span class="hljs-comment">;CX-1!=0,循环到showtime2，继续读取时间参数</span>
    <span class="hljs-keyword">in</span> al,<span class="hljs-number">60</span>h                   <span class="hljs-comment">;读键盘</span>
    cmp al,<span class="hljs-number">06</span>h                  <span class="hljs-comment">;5键的扫描码</span>
    je ccolor2                  <span class="hljs-comment">;当输入为5时会跳转到修改颜色函数，否则跳过</span>
    <span class="hljs-keyword">jmp</span> notccolor
 ccolor2:
    <span class="hljs-keyword">call</span> changecolor
 notccolor:
    cmp al,<span class="hljs-number">10</span>h                  <span class="hljs-comment">;Q键的扫描码</span>
    je quit                     <span class="hljs-comment">;Q键退出</span>
    <span class="hljs-keyword">jmp</span> showtime1               <span class="hljs-comment">;跳转到showtime1</span>
 quit:
    <span class="hljs-keyword">ret</span>                   
showtime endp</code></pre>
<ul>
<li>修改时间</li>
</ul>
<pre class="prettyprint"><code class=" hljs perl">settime proc
  jmp short begin
  <span class="hljs-keyword">s</span> db <span class="hljs-number">9</span>,<span class="hljs-number">8</span>,<span class="hljs-number">7</span>,<span class="hljs-number">4</span>,<span class="hljs-number">2</span>,<span class="hljs-number">0</span>             ;CMOS中时间参数的存储位置
  msg<span class="hljs-number">0</span> db <span class="hljs-number">30</span> DUP(<span class="hljs-string">'!'</span>)          ;用于存储用户输入
  msg1 db <span class="hljs-string">'please input the time format:xx/xx/xx xx:xx:xx'</span>,<span class="hljs-number">0</span>    ;时间格式字符串
  msg2 db <span class="hljs-number">30</span> DUP(<span class="hljs-string">'$'</span>)          ;用于存储转换后的BCD码

 begin:
  mov dh,<span class="hljs-number">10</span>
  mov dl,<span class="hljs-number">15</span>
  mov si,offset msg1
  mov cl,<span class="hljs-number">01</span>h
  call show_str                ;显示msg1，提示用户输入
  mov bx, offset msg<span class="hljs-number">0</span>
  mov ax,0b800h
  mov es,ax                    ;定位到显存位置，用户显示用户输入
  mov di,<span class="hljs-number">0</span>                     ;字符串位置初始化
  mov si,<span class="hljs-number">0</span>                     ;显存位置初始化

 int21:
  mov ah,<span class="hljs-number">00</span>h                   ;循环调用<span class="hljs-keyword">int</span> <span class="hljs-number">16</span>h中断，获取用户输入
  <span class="hljs-keyword">int</span> <span class="hljs-number">16</span>h
  cmp ah,0eh
  je set_back                  ;若为退格键，进行相应的处理
  cmp ah,<span class="hljs-number">1</span>ch
  je set_enter                 ;若为回车键，进行相应的处理
  cmp di,<span class="hljs-number">17</span>                    ;若输入已经为<span class="hljs-number">17</span>个字符,则不再读取输入
  je int21

  mov cs:[bx+di],al            ;存储数据
  mov es:[si],al               ;显示数据
  inc di                       ;定位到下一个字符存储位置
  add si,<span class="hljs-number">2</span>                     ;定位到下一个显存位置
  jmp int21

 set_back:
  cmp di,<span class="hljs-number">0</span>                     ;若此时处于起始位置，则不进行删除操作
  je con
  <span class="hljs-sub"><span class="hljs-keyword">sub</span> si,2                     ;</span>显存位置定位到前一个
  <span class="hljs-sub"><span class="hljs-keyword">sub</span> di,1                     ;</span>存储位置定位到前一个
  mov al,<span class="hljs-number">20</span>h
  mov es:[si],al               ;将前一个显存置为空格
con:
  jmp int21

 set_enter:
  cmp di,<span class="hljs-number">17</span>                    ;若输入长度不足<span class="hljs-number">17</span>，则返回继续监测输入
  jb int21
  mov bx,offset msg<span class="hljs-number">0</span>           ;定位到输入字符串
  mov di,offset msg2           ;定位到数据存储段
  call ASCIItoBCD              ;将用户输入转为BCD码
  mov di,offset <span class="hljs-keyword">s</span>              ;CMOS中时间参数的存储位置
  mov dx,offset msg2           ;存储处理后的用户输入
  call settime_s               ;处理用户收入完毕，调用设置时间函数
  call showtime                ;时间设置完毕，显示当前时间
  ret
settime endp

 ASCIItoBCD proc                ;输入参数为al 输出结果为al
  <span class="hljs-keyword">push</span> cx                      ;保存现场
  <span class="hljs-keyword">push</span> di
  <span class="hljs-keyword">push</span> ax
  <span class="hljs-keyword">push</span> bp
  <span class="hljs-keyword">push</span> bx

  mov cx,<span class="hljs-number">18</span>                    ;设置循环处理次数

 A1:                           ;转为BCD码 第一步
  mov al,cs:[bx]
  <span class="hljs-sub"><span class="hljs-keyword">sub</span> al,30h                   ;</span>ASCII转为数字
  mov cs:[bx],al               ;存入原位置
  inc bx
  loop A1
  <span class="hljs-keyword">pop</span> bx                       ;恢复输入字符串初始位置，准备第二步操作
  <span class="hljs-keyword">push</span> bx                      ;字符串初始位置入栈
  mov cx,<span class="hljs-number">6</span>

 A2:                           ;转为BCD码 第二步
  mov ah,cs:[bx]
  mov al,cs:[bx+<span class="hljs-number">1</span>]             ;得到前两个输入数据
  <span class="hljs-keyword">push</span> cx
  mov cl,<span class="hljs-number">4</span>
  shl ah,cl                    ;左移四位，存入高位
  <span class="hljs-keyword">pop</span> cx
  <span class="hljs-keyword">xor</span> ah,al                    ;ah即为ah与al拼接的BCD码
  mov cs:[di],ah
  inc di
  add bx,<span class="hljs-number">3</span>                     ;定位到下一个有效数据
  loop A2

  <span class="hljs-keyword">pop</span> bx                       ;恢复现场
  <span class="hljs-keyword">pop</span> bp
  <span class="hljs-keyword">pop</span> ax
  <span class="hljs-keyword">pop</span> di
  <span class="hljs-keyword">pop</span> cx
  ret
 ASCIItoBCD endp

 settime_s proc  
  <span class="hljs-keyword">push</span> cx                     ;保存现场
  <span class="hljs-keyword">push</span> di
  <span class="hljs-keyword">push</span> ax
  <span class="hljs-keyword">push</span> bp
  <span class="hljs-keyword">push</span> bx   

  mov cx,<span class="hljs-number">6</span>                     ;CX=<span class="hljs-number">6</span>
  mov bx,di                    ;BX指向<span class="hljs-keyword">s</span>首地址,  <span class="hljs-keyword">s</span>为<span class="hljs-number">70</span>端口每次所需要的入口参数数组的首地址
  mov di,dx                    ;di指向存储处理后数据

 set:
  mov al,cs:[bx]               ;取当前需要的<span class="hljs-number">70</span>端口的入口参数
  out <span class="hljs-number">70</span>h,al                   ;al-&gt;PORT <span class="hljs-number">70</span>,指示<span class="hljs-number">71</span>端口要取的数据   
  mov al,cs:[di]
  out <span class="hljs-number">71</span>h, al                  ;PORT <span class="hljs-number">71</span>-&gt;al，数据输入CMOS
  inc di
  inc bx                       ;自增后，继续设置
  loop set

  <span class="hljs-keyword">pop</span> bx                       ;恢复现场
  <span class="hljs-keyword">pop</span> bp
  <span class="hljs-keyword">pop</span> ax
  <span class="hljs-keyword">pop</span> di
  <span class="hljs-keyword">pop</span> cx
  ret
 settime_s endp</code></pre>
<ul>
<li>重启系统</li>
</ul>
<pre class="prettyprint"><code class=" hljs avrasm">restart_sys proc               <span class="hljs-comment">;系统重启函数</span>
  <span class="hljs-keyword">mov</span> ax,<span class="hljs-number">0</span>ffffh
  <span class="hljs-keyword">push</span> ax
  <span class="hljs-keyword">mov</span> ax,<span class="hljs-number">00</span>h
  <span class="hljs-keyword">push</span> ax
  retf                         <span class="hljs-comment">;将CS:IP恢复为0ffff：0000,重新启动</span>
restart_sys endp</code></pre>
<ul>
<li>进入磁盘系统</li>
</ul>
<pre class="prettyprint"><code class=" hljs avrasm">go_disksys proc                <span class="hljs-comment">;进入操作系统函数</span>
  <span class="hljs-keyword">call</span> Clearall

  <span class="hljs-keyword">mov</span> ax,<span class="hljs-number">00</span>h
  <span class="hljs-keyword">mov</span> es,ax
  <span class="hljs-keyword">mov</span> bx,<span class="hljs-number">7</span>c00h                 <span class="hljs-comment">;设置存储数据的内存初始地址为0:7c00h</span>

  <span class="hljs-comment">;设置用于启动硬盘系统的参数</span>
  <span class="hljs-keyword">mov</span> al,<span class="hljs-number">1</span>                     <span class="hljs-comment">;读取的扇区数</span>
  <span class="hljs-keyword">mov</span> ch,<span class="hljs-number">0</span>                     <span class="hljs-comment">;0磁道</span>
  <span class="hljs-keyword">mov</span> cl,<span class="hljs-number">1</span>                     <span class="hljs-comment">;1扇区</span>
  <span class="hljs-keyword">mov</span> dl,<span class="hljs-number">80</span>h                   <span class="hljs-comment">;C盘</span>
  <span class="hljs-keyword">mov</span> dh,<span class="hljs-number">0</span>                     <span class="hljs-comment">;0面</span>

  <span class="hljs-keyword">mov</span> ah,<span class="hljs-number">2</span> 
  int <span class="hljs-number">13</span>h                      <span class="hljs-comment">;调用int 13h的2号功能，根据以上参数读取磁盘信息到指定位置</span>

  <span class="hljs-keyword">mov</span> ax,<span class="hljs-number">00</span>h
  <span class="hljs-keyword">push</span> ax
  <span class="hljs-keyword">mov</span> ax,<span class="hljs-number">7</span>c00h
  <span class="hljs-keyword">push</span> ax
  retf                         <span class="hljs-comment">;将CS:IP设置为0000:7c00h，启动磁盘系统</span>
go_disksys endp</code></pre>
<ul>
<li>修改颜色</li>
</ul>
<pre class="prettyprint"><code class=" hljs avrasm">changecolor proc                <span class="hljs-comment">;用于改变颜色的函数</span>
  <span class="hljs-keyword">push</span> ax                       <span class="hljs-comment">;保存现场，函数中要用到的参数</span>
  <span class="hljs-keyword">push</span> es
  <span class="hljs-keyword">push</span> bp
  <span class="hljs-keyword">push</span> bx
  <span class="hljs-keyword">push</span> cx

  <span class="hljs-keyword">mov</span> ax,<span class="hljs-number">0</span>b800h
  <span class="hljs-keyword">mov</span> es,ax
  <span class="hljs-keyword">mov</span> bp,<span class="hljs-number">1</span>                      <span class="hljs-comment">;定位到显存第一个颜色位置</span>

  <span class="hljs-keyword">mov</span> bl,es:[bp]                <span class="hljs-comment">;读取此时屏幕的颜色</span>
  <span class="hljs-keyword">inc</span> bl
  <span class="hljs-keyword">and</span> bl,<span class="hljs-number">00000111</span>b              <span class="hljs-comment">;防止超出7</span>
  cmp bl,<span class="hljs-number">0</span>                      <span class="hljs-comment">;这里的判断是因为程序启动时，</span>
  jne ccolor1                   <span class="hljs-comment">;一部分颜色位可能没有初始化，</span>
  <span class="hljs-keyword">inc</span> bl                        <span class="hljs-comment">;会导致显示不稳定,颜色首先为黑色</span>
  <span class="hljs-keyword">and</span> bl,<span class="hljs-number">00000111</span>b              <span class="hljs-comment">;通过判断，改变这种情况</span>

 ccolor1:
  <span class="hljs-keyword">mov</span> cx,<span class="hljs-number">2000</span>

 changecolor_s:
  <span class="hljs-keyword">mov</span> es:[bp],bl                <span class="hljs-comment">;循环修改颜色位，作用范围是全屏</span>
  <span class="hljs-keyword">add</span> bp,<span class="hljs-number">2</span>
  loop changecolor_s

  <span class="hljs-keyword">pop</span> cx                        <span class="hljs-comment">;恢复现场，函数调用前的参数出栈</span>
  <span class="hljs-keyword">pop</span> bx
  <span class="hljs-keyword">pop</span> bp
  <span class="hljs-keyword">pop</span> es
  <span class="hljs-keyword">pop</span> ax
  <span class="hljs-keyword">ret</span>
changecolor endp</code></pre>
<ul>
<li><strong>其他所需子函数</strong></li>
<li>清屏</li>
</ul>
<pre class="prettyprint"><code class=" hljs avrasm">Clearall proc                  <span class="hljs-comment">;清屏函数</span>
  <span class="hljs-keyword">push</span> ax                      <span class="hljs-comment">;保存现场</span>
  <span class="hljs-keyword">push</span> es
  <span class="hljs-keyword">push</span> bp
  <span class="hljs-keyword">push</span> cx

  <span class="hljs-keyword">mov</span> ax,<span class="hljs-number">0</span>b800h                <span class="hljs-comment">;定位到显存位置</span>
  <span class="hljs-keyword">mov</span> es,ax
  <span class="hljs-keyword">mov</span> bp,<span class="hljs-number">00</span>h
  <span class="hljs-keyword">mov</span> cx,<span class="hljs-number">2000</span>

 clear_s:
  <span class="hljs-keyword">mov</span> es:[bp],byte ptr <span class="hljs-string">' '</span>     <span class="hljs-comment">;全屏写入“ ”</span>
  <span class="hljs-keyword">add</span> bp,<span class="hljs-number">2</span>
  loop clear_s

  <span class="hljs-keyword">pop</span> cx                       <span class="hljs-comment">;恢复现场</span>
  <span class="hljs-keyword">pop</span> bp
  <span class="hljs-keyword">pop</span> es
  <span class="hljs-keyword">pop</span> ax
  <span class="hljs-keyword">ret</span>
Clearall endp</code></pre>
<ul>
<li>显示一个以0为结尾标志的字符串</li>
</ul>
<pre class="prettyprint"><code class=" hljs avrasm">show_str proc                  <span class="hljs-comment">;显示一段0标识结束的字符串</span>
  <span class="hljs-keyword">push</span> ax                      <span class="hljs-comment">;保存现场</span>
  <span class="hljs-keyword">push</span> cx
  <span class="hljs-keyword">push</span> dx
  <span class="hljs-keyword">push</span> si
  <span class="hljs-keyword">push</span> bp
  <span class="hljs-keyword">push</span> es

  <span class="hljs-keyword">mov</span> ax,<span class="hljs-number">0</span>b800h                <span class="hljs-comment">;定位到显存位置</span>
  <span class="hljs-keyword">mov</span> es,ax
  <span class="hljs-keyword">mov</span> al,<span class="hljs-number">80</span>*<span class="hljs-number">2</span><span class="hljs-comment">;                 ;处理行号dh*80*2</span>
  <span class="hljs-keyword">mul</span> dh
  <span class="hljs-keyword">mov</span> dh,<span class="hljs-number">0</span>                     <span class="hljs-comment">;接下来处理列号dl</span>
  <span class="hljs-keyword">add</span> dx,dx                    <span class="hljs-comment">;dx*2位一行中的偏移</span>
  <span class="hljs-keyword">add</span> ax,dx
  <span class="hljs-keyword">mov</span> bp,ax                    <span class="hljs-comment">;总的偏移</span>

 showoption:
  <span class="hljs-keyword">mov</span> ch,ds:[si]               <span class="hljs-comment">;定位到字符串</span>
  cmp ch,<span class="hljs-number">0</span>                     <span class="hljs-comment">;当数据为0时，显示完毕，退出</span>
  je showstr_back
  <span class="hljs-keyword">mov</span> es:[bp],ch
  <span class="hljs-keyword">inc</span> bp
  <span class="hljs-keyword">mov</span> es:[bp],cl
  <span class="hljs-keyword">inc</span> bp
  <span class="hljs-keyword">inc</span> si                       <span class="hljs-comment">;修改显存以及字符指向，准备显示下一字符</span>
  <span class="hljs-keyword">jmp</span> showoption

 showstr_back:
  <span class="hljs-keyword">pop</span> es                       <span class="hljs-comment">;恢复现场</span>
  <span class="hljs-keyword">pop</span> bp
  <span class="hljs-keyword">pop</span> si
  <span class="hljs-keyword">pop</span> dx
  <span class="hljs-keyword">pop</span> cx
  <span class="hljs-keyword">pop</span> ax
  <span class="hljs-keyword">ret</span>
show_str endp</code></pre>
<h3 id="其他注意点">其他注意点</h3>
<ul>
<li>在显示菜单时，本来使用了循环结构，但是显示总是乱码，于是采用了六次显示字符串的操作</li>
<li>在修改时间时，本来想调用int21，接收用户的一个字符串的，但是没有个发生中断，因此采用了int16中断，通过循环以及容错控制模仿了近似int21的功能，允许用户输入或删除字符，并在左上角显示，必须输入17个字符后，点击回车才能执行修改时间的操作。</li>
<li>为了显示用户的输入，需要修改显存，编程过程中，因为乱用寄存器，导致一直出错，修改显存时改为采用es段寄存器就不会出问题了</li>
</ul>
<h2 id="实验过程记录">实验过程记录</h2>
<h3 id="准备工作">准备工作</h3>
<ol>
<li>加载软盘并格式化 <br>
<img alt="这里写图片描述" src="http://img.blog.csdn.net/20170115090236382?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvcXFfMzE0ODExODc=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" title=""> <br>
<img alt="这里写图片描述" src="http://img.blog.csdn.net/20170115090632841?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvcXFfMzE0ODExODc=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" title=""/></br></img></br></li>
<li>烧录ULoader以及SYSTEM_U <br>
<img alt="这里写图片描述" src="http://img.blog.csdn.net/20170115091604667?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvcXFfMzE0ODExODc=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" title=""> <br>
SYSTEM_U需要两个扇区 <br>
<img alt="这里写图片描述" src="http://img.blog.csdn.net/20170115091721059?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvcXFfMzE0ODExODc=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" title=""/></br></br></img></br></li>
</ol>
<h3 id="系统操作">系统操作</h3>
<ol>
<li>启动系统 <br>
<img alt="这里写图片描述" src="http://img.blog.csdn.net/20170115093919135?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvcXFfMzE0ODExODc=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" title=""> <br>
<strong>按下5键修改颜色</strong>，采取的办法是避开黑色以及当前颜色代码加1 <br>
<img alt="这里写图片描述" src="http://img.blog.csdn.net/20170115100352676?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvcXFfMzE0ODExODc=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" title=""/></br></br></img></br></li>
<li>按下<strong>1键</strong>查看系统时间 <br>

<strong>按下5键修改颜色</strong>因为扫描用户输入的速度非常快，所以按下时会出现多彩闪烁的效果 <br>
<img alt="这里写图片描述" src="http://img.blog.csdn.net/20170115102527577?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvcXFfMzE0ODExODc=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" title=""> <br>
按下<strong>Q键</strong>退回主菜单</br></img></br></br></img></br></li>
<li>修改系统时间 <br>
初始界面： <br>
<img alt="这里写图片描述" src="http://img.blog.csdn.net/20170115103109079?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvcXFfMzE0ODExODc=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" title=""> <br>
根据格式输入时间（可以进行退格删除的操作）： <br>
<img alt="这里写图片描述" src="http://img.blog.csdn.net/20170115121928269?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvcXFfMzE0ODExODc=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" title=""> <br>
位数正确的情况下，按下回车，时间修改成功并立刻显示 <br>
<img alt="这里写图片描述" src="http://img.blog.csdn.net/20170115122012984?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvcXFfMzE0ODExODc=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" title=""> <br>
此时，可以按<strong>5键</strong>修改颜色，或按<strong>Q键</strong>退回主菜单 <br>
查看此时的系统时间： <br>
<img alt="这里写图片描述" src="http://img.blog.csdn.net/20170115121733128?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvcXFfMzE0ODExODc=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" title=""> <br>
修改成功</br></img></br></br></br></img></br></br></img></br></br></img></br></br></li>
<li>主菜单按下<strong>3键</strong>系统重启，依然来到主菜单</li>
<li>主菜单按下<strong>4键</strong>启动磁盘系统 <br>
<img alt="这里写图片描述" src="http://img.blog.csdn.net/20170115104337835?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvcXFfMzE0ODExODc=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" title=""/></br></li>
</ol>
<h2 id="实验总结">实验总结</h2>
<ol>
<li>对系统是如何启动的有了更多的理解，了解了裸机编程的原理</li>
<li>学习了查看以及修改时间的方法，对CMOS也更加了解，学习了端口读取数据，中断的使用方法</li>
<li>对汇编指令进行实践，增加了熟练度</li>
<li>同时，认识到在汇编编程中，寄存器使用要规范，不可以乱用，各个寄存器有各个寄存器的主要用途</li>
</ol></div>
