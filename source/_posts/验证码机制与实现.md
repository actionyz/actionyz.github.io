---
title: 验证码机制与实现
tags: [PHP]
date: 2017-06-16 19:59
---
时下图形验证码的应用已经非常广泛了，无论是在web应用还是客户端软件中。主要是用来防止字典攻击（或称暴力猜解）、机器注册等   本篇文章主要讲解验证码实现机制与安全策略突破
<!-- more -->
<link rel="stylesheet" type="text/css" href="http://static.blog.csdn.net/css/csdn_blog_detail.min.css">
<div class="markdown_views"><blockquote>
<p>时下图形验证码的应用已经非常广泛了，无论是在web应用还是客户端软件中。主要是用来防止字典攻击（或称暴力猜解）、机器注册等 <br>
  本篇文章主要讲解验证码实现机制与安全策略突破</br></p>
</blockquote>
<h1 id="0x01-原理分析">0x01 原理分析</h1>
<p><img alt="这里写图片描述" src="http://img.blog.csdn.net/20170616194007059?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvcXFfMzE0ODExODc=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" title=""/></p>
<blockquote>
<p>1.客户端发起一个请求； <br>
  2.服务端响应并创建一个新的SessionID同时生成一个随机验证码； <br>
  3.服务端将验证码和SessionID一并返回给客户端； <br>
  4.客户端提交验证码连同SessionID给服务端； <br>
  5.服务端验证验证码同时销毁当前Session中的验证码，返回给客户端结果。</br></br></br></br></p>
</blockquote>
<h1 id="0x02-代码实现">0x02 代码实现</h1>
<p>这里用了网上的一个例子 <br>
<code>login.html</code></br></p>
<pre class="prettyprint"><code class=" hljs xml"><span class="hljs-doctype">&lt;!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-title">html</span> <span class="hljs-attribute">xmlns</span>=<span class="hljs-value">"http://www.w3.org/1999/xhtml"</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-title">head</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-title">meta</span> <span class="hljs-attribute">http-equiv</span>=<span class="hljs-value">"Content-Type"</span> <span class="hljs-attribute">content</span>=<span class="hljs-value">"text/html; charset=utf-8"</span> /&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-title">title</span>&gt;</span>无标题文档<span class="hljs-tag">&lt;/<span class="hljs-title">title</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-title">head</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-title">body</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-title">form</span> <span class="hljs-attribute">method</span>=<span class="hljs-value">"post"</span> <span class="hljs-attribute">action</span>=<span class="hljs-value">"./check.php"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-title">p</span>&gt;</span>验证码: <span class="hljs-tag">&lt;<span class="hljs-title">img</span> <span class="hljs-attribute">id</span>=<span class="hljs-value">"captcha_img"</span> <span class="hljs-attribute">border</span>=<span class="hljs-value">'1'</span> <span class="hljs-attribute">src</span>=<span class="hljs-value">'./image.php?r=echo rand(); ?&gt;'</span> <span class="hljs-attribute">style</span>=<span class="hljs-value">"width:100px; height:30px"</span> /&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-title">a</span>  <span class="hljs-attribute">onclick</span>=<span class="hljs-value">"document.getElementById('captcha_img').src='./image.php?r='+Math.random()"</span>&gt;</span>换一个?<span class="hljs-tag">&lt;/<span class="hljs-title">a</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-title">p</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-title">P</span>&gt;</span>请输入验证码:<span class="hljs-tag">&lt;<span class="hljs-title">input</span> <span class="hljs-attribute">type</span>=<span class="hljs-value">"text"</span> <span class="hljs-attribute">name</span>=<span class="hljs-value">'authcode'</span> <span class="hljs-attribute">value</span>=<span class="hljs-value">''</span>/&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-title">p</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-title">p</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-title">input</span> <span class="hljs-attribute">type</span>=<span class="hljs-value">'submit'</span> <span class="hljs-attribute">value</span>=<span class="hljs-value">'提交'</span> <span class="hljs-attribute">style</span>=<span class="hljs-value">'padding:6px 5px;'</span>/&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-title">p</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-title">form</span>&gt;</span>

<span class="hljs-tag">&lt;/<span class="hljs-title">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-title">html</span>&gt;</span></code></pre>
<p><code>check.php</code></p>
<pre class="prettyprint"><code class=" hljs django"><span class="xml"><span class="php"><span class="hljs-preprocessor">&lt;?php</span>
  header(<span class="hljs-string">"Content-Type:text/html;charset=utf-8"</span>);      <span class="hljs-comment">//设置头部信息</span>
  <span class="hljs-comment">//isset()检测变量是否设置</span>
  <span class="hljs-keyword">if</span>(<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_REQUEST</span>[<span class="hljs-string">'authcode'</span>])){
    session_start();
    <span class="hljs-comment">//strtolower()小写函数</span>
    <span class="hljs-keyword">echo</span> var_dump(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">'authcode'</span>]),var_dump(<span class="hljs-variable">$_SESSION</span>[<span class="hljs-string">'authcode'</span>]);
    <span class="hljs-keyword">if</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">'authcode'</span>] === <span class="hljs-variable">$_SESSION</span>[<span class="hljs-string">'authcode'</span>]){
      <span class="hljs-comment">//跳转页面</span>
      <span class="hljs-keyword">echo</span> <span class="hljs-string">"&lt;script language=\"javascript\"&gt;"</span>;
      <span class="hljs-keyword">echo</span> <span class="hljs-string">"alert('yes!"</span>.<span class="hljs-variable">$_REQUEST</span>[<span class="hljs-string">'authcode'</span>].<span class="hljs-string">"');"</span>;
      <span class="hljs-keyword">echo</span> <span class="hljs-string">"document.location=\"./login.html\""</span>;
      <span class="hljs-keyword">echo</span> <span class="hljs-string">"&lt;/script&gt;"</span>;
    }<span class="hljs-keyword">else</span>{
      <span class="hljs-comment">//提示以及跳转页面</span>
      <span class="hljs-keyword">echo</span> <span class="hljs-string">"&lt;script language=\"javascript\"&gt;"</span>;
      <span class="hljs-keyword">echo</span> <span class="hljs-string">"alert('输入错误!"</span>.<span class="hljs-variable">$_REQUEST</span>[<span class="hljs-string">'authcode'</span>].<span class="hljs-string">"');"</span>;
      <span class="hljs-keyword">echo</span> <span class="hljs-string">"document.location=\"./login.html\""</span>;
      <span class="hljs-keyword">echo</span> <span class="hljs-string">"&lt;/script&gt;"</span>;
    }
    <span class="hljs-keyword">exit</span>();
   }
  <span class="hljs-preprocessor">?&gt;</span></span>
</span></code></pre>
<p><code>image.php</code></p>
<pre class="prettyprint"><code class=" hljs mel">&lt;?php
  <span class="hljs-comment">//11&gt;设置session,必须处于脚本最顶部</span>
  session_start();
  <span class="hljs-variable">$image</span> = imagecreatetruecolor(<span class="hljs-number">100</span>, <span class="hljs-number">30</span>);    <span class="hljs-comment">//1&gt;设置验证码图片大小的函数</span>
  <span class="hljs-comment">//5&gt;设置验证码颜色 imagecolorallocate(int im, int red, int green, int blue);</span>
  <span class="hljs-variable">$bgcolor</span> = imagecolorallocate(<span class="hljs-variable">$image</span>,<span class="hljs-number">255</span>,<span class="hljs-number">255</span>,<span class="hljs-number">255</span>); <span class="hljs-comment">//#ffffff</span>
  <span class="hljs-comment">//6&gt;区域填充 int imagefill(int im, int x, int y, int col) (x,y) 所在的区域着色,col 表示欲涂上的颜色</span>
  imagefill(<span class="hljs-variable">$image</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-variable">$bgcolor</span>);
  <span class="hljs-comment">//10&gt;设置变量</span>
  <span class="hljs-variable">$captcha_code</span> = <span class="hljs-string">""</span>;
<span class="hljs-comment">//7&gt;生成随机的字母和数字</span>
  <span class="hljs-keyword">for</span>(<span class="hljs-variable">$i</span>=<span class="hljs-number">0</span>;<span class="hljs-variable">$i</span>&lt;<span class="hljs-number">4</span>;<span class="hljs-variable">$i</span>++){
    <span class="hljs-comment">//设置字体大小</span>
    <span class="hljs-variable">$fontsize</span> = <span class="hljs-number">8</span>;    
    <span class="hljs-comment">//设置字体颜色，随机颜色</span>
    <span class="hljs-variable">$fontcolor</span> = imagecolorallocate(<span class="hljs-variable">$image</span>, <span class="hljs-keyword">rand</span>(<span class="hljs-number">0</span>,<span class="hljs-number">120</span>),<span class="hljs-keyword">rand</span>(<span class="hljs-number">0</span>,<span class="hljs-number">120</span>), <span class="hljs-keyword">rand</span>(<span class="hljs-number">0</span>,<span class="hljs-number">120</span>));      <span class="hljs-comment">//0-120深颜色</span>
    <span class="hljs-comment">//设置需要随机取的值,去掉容易出错的值如0和o</span>
    <span class="hljs-variable">$data</span> =<span class="hljs-string">'abcdefghigkmnpqrstuvwxy3456789'</span>;
    <span class="hljs-comment">//取出值，字符串截取方法  strlen获取字符串长度</span>
    <span class="hljs-variable">$fontcontent</span> = substr(<span class="hljs-variable">$data</span>, <span class="hljs-keyword">rand</span>(<span class="hljs-number">0</span>,strlen(<span class="hljs-variable">$data</span>)),<span class="hljs-number">1</span>);
    <span class="hljs-comment">//10&gt;.=连续定义变量</span>
    <span class="hljs-variable">$captcha_code</span> .= <span class="hljs-variable">$fontcontent</span>;    
    <span class="hljs-comment">//设置坐标</span>
    <span class="hljs-variable">$x</span> = (<span class="hljs-variable">$i</span><span class="hljs-variable">*100</span>/<span class="hljs-number">4</span>)+<span class="hljs-keyword">rand</span>(<span class="hljs-number">5</span>,<span class="hljs-number">10</span>);
    <span class="hljs-variable">$y</span> = <span class="hljs-keyword">rand</span>(<span class="hljs-number">5</span>,<span class="hljs-number">10</span>);
    imagestring(<span class="hljs-variable">$image</span>,<span class="hljs-variable">$fontsize</span>,<span class="hljs-variable">$x</span>,<span class="hljs-variable">$y</span>,<span class="hljs-variable">$fontcontent</span>,<span class="hljs-variable">$fontcolor</span>);
  }
  <span class="hljs-comment">//10&gt;存到session</span>
  <span class="hljs-variable">$_SESSION</span>[<span class="hljs-string">'authcode'</span>] = <span class="hljs-variable">$captcha_code</span>;
  <span class="hljs-comment">//8&gt;增加干扰元素，设置雪花点</span>
  <span class="hljs-keyword">for</span>(<span class="hljs-variable">$i</span>=<span class="hljs-number">0</span>;<span class="hljs-variable">$i</span>&lt;<span class="hljs-number">200</span>;<span class="hljs-variable">$i</span>++){
    <span class="hljs-comment">//设置点的颜色，50-200颜色比数字浅，不干扰阅读</span>
    <span class="hljs-variable">$pointcolor</span> = imagecolorallocate(<span class="hljs-variable">$image</span>,<span class="hljs-keyword">rand</span>(<span class="hljs-number">50</span>,<span class="hljs-number">200</span>), <span class="hljs-keyword">rand</span>(<span class="hljs-number">50</span>,<span class="hljs-number">200</span>), <span class="hljs-keyword">rand</span>(<span class="hljs-number">50</span>,<span class="hljs-number">200</span>));    
    <span class="hljs-comment">//imagesetpixel — 画一个单一像素</span>
    imagesetpixel(<span class="hljs-variable">$image</span>, <span class="hljs-keyword">rand</span>(<span class="hljs-number">1</span>,<span class="hljs-number">99</span>), <span class="hljs-keyword">rand</span>(<span class="hljs-number">1</span>,<span class="hljs-number">29</span>), <span class="hljs-variable">$pointcolor</span>);
  }
  <span class="hljs-comment">//9&gt;增加干扰元素，设置横线</span>
  <span class="hljs-keyword">for</span>(<span class="hljs-variable">$i</span>=<span class="hljs-number">0</span>;<span class="hljs-variable">$i</span>&lt;<span class="hljs-number">4</span>;<span class="hljs-variable">$i</span>++){
    <span class="hljs-comment">//设置线的颜色</span>
    <span class="hljs-variable">$linecolor</span> = imagecolorallocate(<span class="hljs-variable">$image</span>,<span class="hljs-keyword">rand</span>(<span class="hljs-number">80</span>,<span class="hljs-number">220</span>), <span class="hljs-keyword">rand</span>(<span class="hljs-number">80</span>,<span class="hljs-number">220</span>),<span class="hljs-keyword">rand</span>(<span class="hljs-number">80</span>,<span class="hljs-number">220</span>));
    <span class="hljs-comment">//设置线，两点一线</span>
    imageline(<span class="hljs-variable">$image</span>,<span class="hljs-keyword">rand</span>(<span class="hljs-number">1</span>,<span class="hljs-number">99</span>), <span class="hljs-keyword">rand</span>(<span class="hljs-number">1</span>,<span class="hljs-number">29</span>),<span class="hljs-keyword">rand</span>(<span class="hljs-number">1</span>,<span class="hljs-number">99</span>), <span class="hljs-keyword">rand</span>(<span class="hljs-number">1</span>,<span class="hljs-number">29</span>),<span class="hljs-variable">$linecolor</span>);
  }

  <span class="hljs-comment">//2&gt;设置头部，image/png</span>
  header(<span class="hljs-string">'Content-Type: image/png'</span>);
  <span class="hljs-comment">//3&gt;imagepng() 建立png图形函数</span>
  imagepng(<span class="hljs-variable">$image</span>);
  <span class="hljs-comment">//4&gt;imagedestroy() 结束图形函数 销毁$image</span>
  <span class="hljs-comment">//imagedestroy($image);</span>
  ?&gt;</code></pre>
<p>会生成image图片以及session值</p>
<h1 id="0x03-效果展示">0x03 效果展示</h1>
<p><img alt="这里写图片描述" src="http://img.blog.csdn.net/20170616194959038?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvcXFfMzE0ODExODc=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" title=""/></p>
<h1 id="0x04-攻击手段">0x04 攻击手段</h1>
<p>这里就不详细阐述了 <br>
<a href="http://www.freebuf.com/articles/database/134343.html">可以参考freebuf上的一篇文章</a></br></p></div>