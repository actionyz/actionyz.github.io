---
title: 堆溢出利用
tags: [Linux]
date: 2017-05-02 21:53
---
堆的工作原理与利用
<!-- more -->
<link rel="stylesheet" type="text/css" href="http://static.blog.csdn.net/css/csdn_blog_detail.min.css">
<div class="markdown_views"><p><div class="toc"><div class="toc">
<ul>
<li><a href="#0x00-堆的工作原理">0x00 堆的工作原理</a><ul>
<li><a href="#0x0-数据结构">0x0 数据结构</a><ul>
<li><a href="#堆块">堆块</a></li>
<li><a href="#堆表">堆表</a></li>
</ul>
</li>
<li><a href="#0x1-申请">0x1 申请</a></li>
<li><a href="#0x2-使用">0x2 使用</a></li>
<li><a href="#0x3-释放">0x3 释放</a></li>
</ul>
</li>
</ul>
</div>
</div>
</p>
<h1 id="0x00-堆的工作原理">0x00 堆的工作原理</h1>
<h2 id="0x0-数据结构">0x0 数据结构</h2>
<h3 id="堆块">堆块</h3>
<p>堆块包括块首与块身（返回的指针指向），块首是一个堆块头部的几个字节，用来标识这个堆块自身的信息。</p>
<p></p><center> <br>
<img alt="这里写图片描述" src="http://img.blog.csdn.net/20170502212815985?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvcXFfMzE0ODExODc=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" title=""> <br>
未被占用的堆区</br></img></br></center><p></p>
<p></p><center> <br>
<img alt="这里写图片描述" src="http://img.blog.csdn.net/20170502212831125?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvcXFfMzE0ODExODc=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" title=""> <br>
被占用的堆区</br></img></br></center><p></p>
<h3 id="堆表">堆表</h3>
<p>位于堆区的起始位置，堆表分为两种空闲双向链表Freelist（空表 128条）和快速单向链表Lookaside（快表 最多只有四项）</p>
<blockquote>
<p>堆区一开始的堆表区中有一个128项的指针数组（看到有人说把它看成队列的），被称作空表索引。该数组的每一项包含两个指针，用于表示一条空表。 <br>
  free[1] 标识了所有堆中所有大小为8字节的空闲堆块，之后每个索引指示的空闲堆块递增8个字节。即： <br>
  free[2]标识了16个字节的空闲堆块。 <br>
  free[k] 标识了 k * 8 个字节的空闲堆块。 <br>
</br></br></br></br></p><center> <br>
<img alt="这里写图片描述" src="http://img.blog.csdn.net/20170502213046723?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvcXFfMzE0ODExODc=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" title=""> <br>
  空闲双向链表Freelist（空表）</br></img></br></center><p></p>
</blockquote>
<p></p><center> <br>
<img alt="这里写图片描述" src="http://img.blog.csdn.net/20170502213101817?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvcXFfMzE0ODExODc=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" title=""> <br>
快速单向链表Lookaside（快表）</br></img></br></center><p></p>
<hr>
<h2 id="0x1-申请">0x1 申请</h2>
<p>堆块的分配有三类： <br>
 - 块表分配  <br>
 - 普通表份分配  <br>
 - 零号表分配（free[0]）</br></br></br></p>
<p>堆的申请首先在快表中查询，如果没有去普通表中查询，如果还没有从内存空间分配。</p>
<h2 id="0x2-使用">0x2 使用</h2>
<p>直接利用堆表中的指针查询堆块，利用返回的指针使用堆内存，并对其操作。</p>
<h2 id="0x3-释放">0x3 释放</h2>
<p>堆的释放首先释放在快表中，如果快表满了再释放到普通表中。</p>
<pre class="prettyprint"><code class=" hljs css">
空表 内存分布
0<span class="hljs-tag">x00520178</span> <span class="hljs-tag">Freelist</span><span class="hljs-attr_selector">[0]</span>  
0<span class="hljs-tag">x00520188</span> <span class="hljs-tag">Freelist</span><span class="hljs-attr_selector">[1]</span>
0<span class="hljs-tag">x00520198</span> <span class="hljs-tag">Freelist</span><span class="hljs-attr_selector">[2]</span>
0<span class="hljs-tag">x005201a8</span> <span class="hljs-tag">Freelist</span><span class="hljs-attr_selector">[3]</span>

块区
0<span class="hljs-tag">x00520680</span> <span class="hljs-tag">h1</span> (加上8<span class="hljs-tag">byte</span>头字节)
0<span class="hljs-tag">x00520690</span> <span class="hljs-tag">h2</span>
0<span class="hljs-tag">x005206a0</span> <span class="hljs-tag">h3</span>
0<span class="hljs-tag">x005206b0</span> <span class="hljs-tag">h4</span>

快表 内存分布
0<span class="hljs-tag">x003606E8</span> <span class="hljs-tag">Lookaside</span><span class="hljs-attr_selector">[1]</span>
0<span class="hljs-tag">x00360718</span> <span class="hljs-tag">Lookaside</span><span class="hljs-attr_selector">[2]</span>
0<span class="hljs-tag">x00360748</span> <span class="hljs-tag">Lookaside</span><span class="hljs-attr_selector">[3]</span>
0<span class="hljs-tag">x00360788</span> <span class="hljs-tag">Lookaside</span><span class="hljs-attr_selector">[4]</span>
堆区
0<span class="hljs-tag">x00361E98</span> <span class="hljs-tag">h1</span>
0<span class="hljs-tag">x00361Ea8</span> <span class="hljs-tag">h3</span>
0<span class="hljs-tag">x00361E98</span> <span class="hljs-tag">h5</span>

</code></pre></hr></div>