---
title: 同源策略 & 内容安全策略
tags: [WEB漏洞]
date: 2016-12-18 16:51
---
为了更好的理解掌握 同源策略（Same origin policy）、内容安全策略(CSP,ContentSecurityPolicy)、跨站脚本攻击(Cross Site Scripting)、跨站请求伪造（Cross-site request forgery）、服务器端请求伪造（Server-Side Request Forgery）做了以下实验环境配置在80端口开放Apache服务器在80
<!-- more -->
<link rel="stylesheet" type="text/css" href="http://static.blog.csdn.net/css/csdn_blog_detail.min.css">
<div class="markdown_views"><p>为了更好的理解掌握 同源策略（Same origin policy）、内容安全策略(CSP,ContentSecurityPolicy)、跨站脚本攻击(Cross Site Scripting)、跨站请求伪造（Cross-site request forgery）、服务器端请求伪造（Server-Side Request Forgery）做了以下实验</p>
<h1 id="环境配置">环境配置</h1>
<ol>
<li>在80端口开放Apache服务器</li>
<li>在8080端口开放Apache服务器</li>
</ol>
<h1 id="实验一-csp验证-绕过csp">实验一 CSP验证 &amp; 绕过CSP</h1>
<p>首先我们来验证CSP的作用，及内容 <br>
首先客户访问localhost:8080/test.php 在header中限制了请求资源</br></p>
<pre class="prettyprint"><code class=" hljs xml">./www2/test.php
<span class="php"><span class="hljs-preprocessor">&lt;?php</span>
header(<span class="hljs-string">"Content-Security-Policy: style-src 'self' 'unsafe-inline';"</span>);
<span class="hljs-preprocessor">?&gt;</span></span>
<span class="hljs-tag">&lt;<span class="hljs-title">link</span> <span class="hljs-attribute">rel</span>=<span class="hljs-value">"stylesheet"</span> <span class="hljs-attribute">type</span>=<span class="hljs-value">"text/css"</span> <span class="hljs-attribute">href</span>=<span class="hljs-value">"http://127.0.0.1/test.php?a=jinlongyu"</span>&gt;</span></code></pre>
<p>接收端代码</p>
<pre class="prettyprint"><code class=" hljs php">www/test.php
<span class="hljs-preprocessor">&lt;?php</span>
<span class="hljs-variable">$file</span> = fopen(<span class="hljs-string">"1.txt"</span>,<span class="hljs-string">"w"</span>);
fwrite(<span class="hljs-variable">$file</span>, <span class="hljs-variable">$_GET</span>[<span class="hljs-string">'a'</span>]);
<span class="hljs-preprocessor">?&gt;</span></code></pre>
<p><img alt="这里写图片描述" src="http://img.blog.csdn.net/20161218191431513?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvcXFfMzE0ODExODc=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" title=""> <br>
说明资源不能被请求，受到了CSP的限制，他只能请求来自本服务器的资源，而一般有XSS防护的网站基本上都会这么做。如果将限制删除那么就不会出现此情况 <br>
如下图所示 <br>
<img alt="这里写图片描述" src="http://img.blog.csdn.net/20161222102357003?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvcXFfMzE0ODExODc=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" title=""> <br>
资源请求成功。 <br>
上面主要是内容安全策略的问题，以及我的理解如有不对请指正。</br></br></img></br></br></br></img></p>
<h1 id="实验二">实验二</h1>
<p>同源策略问题一直以来困扰着我。直到做这个实验的时候才稍微理解了一点，下面我和大家分享一下。 <br>
在HTML资源请求时，只能获取目标服务器资源但不能直接修改该资源。 <br>
下面实验在8080:/1.php嵌入80:/1.php并且试图修改里面的html节点2 <br>
下面来看一下实验代码及实验效果。</br></br></br></p>
<pre class="prettyprint"><code class=" hljs xml">www2/1.php
<span class="hljs-tag">&lt;<span class="hljs-title">meta</span> <span class="hljs-attribute">charset</span>=<span class="hljs-value">"utf-8"</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-title">iframe</span> <span class="hljs-attribute">src</span>=<span class="hljs-value">"http://localhost/1.php"</span> <span class="hljs-attribute">id</span>=<span class="hljs-value">"myframe"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-title">iframe</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-title">script</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-title">a</span> <span class="hljs-attribute">href</span>=<span class="hljs-value">"#"</span> <span class="hljs-attribute">onclick</span>=<span class="hljs-value">"replaceContent()"</span>&gt;</span>点击替换内容<span class="hljs-tag">&lt;/<span class="hljs-title">a</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-title">script</span> <span class="hljs-attribute">type</span>=<span class="hljs-value">"text/javascript"</span>&gt;</span><span class="javascript">
content = <span class="hljs-string">'我把你的这部分理解成读取一段内容'</span>;
            <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">replaceContent</span><span class="hljs-params">()</span>{</span>
                document.getElementById(<span class="hljs-string">'myframe'</span>).contentWindow.document.body.innerText = content;
            }
document.domain = <span class="hljs-string">"localhost"</span>;
</span><span class="hljs-tag">&lt;/<span class="hljs-title">script</span>&gt;</span></code></pre>
<pre class="prettyprint"><code class=" hljs xml">www/1.php
<span class="hljs-doctype">&lt;!DOCTYPE html&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-title">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-title">meta</span> <span class="hljs-attribute">charset</span>=<span class="hljs-value">"utf-8"</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-title">head</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-title">title</span>&gt;</span>测试平台1<span class="hljs-tag">&lt;/<span class="hljs-title">title</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-title">head</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-title">body</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-title">p</span>&gt;</span>hahaha<span class="hljs-tag">&lt;/<span class="hljs-title">p</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-title">p</span>&gt;</span>fuck me<span class="hljs-tag">&lt;/<span class="hljs-title">p</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-title">p</span>&gt;</span>反弹至服务器<span class="hljs-tag">&lt;/<span class="hljs-title">p</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-title">p</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-title">p</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-title">script</span> <span class="hljs-attribute">type</span>=<span class="hljs-value">"text/javascript"</span> &gt;</span><span class="javascript">

</span><span class="hljs-tag">&lt;/<span class="hljs-title">script</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-title">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-title">html</span>&gt;</span></code></pre>
<h2 id="小实验1">小实验1</h2>
<p>我们首先利用上述代码执行，发现被浏览器的同源策略限制了 <br>
<img alt="这里写图片描述" src="http://img.blog.csdn.net/20161222104202073?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvcXFfMzE0ODExODc=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" title=""/></br></p>
<h2 id="小实验2">小实验2</h2>
<p>修改上述代码  将www/1.php加上document.domain = “localhost”; <br>
那么实验效果如下 <br>
<img alt="这里写图片描述" src="http://img.blog.csdn.net/20161222104833729?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvcXFfMzE0ODExODc=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" title=""/></br></br></p>
<h1 id="实验三">实验三</h1>
<pre class="prettyprint"><code class=" hljs xml"><span class="hljs-tag">&lt;<span class="hljs-title">meta</span> <span class="hljs-attribute">charset</span>=<span class="hljs-value">"utf-8"</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-title">script</span> <span class="hljs-attribute">type</span>=<span class="hljs-value">"text/javascript"</span> <span class="hljs-attribute">src</span>=<span class="hljs-value">"http://libs.baidu.com/jquery/2.0.0/jquery.js"</span>&gt;</span><span class="javascript"></span><span class="hljs-tag">&lt;/<span class="hljs-title">script</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-title">iframe</span> <span class="hljs-attribute">src</span>=<span class="hljs-value">"http://localhost/2.php"</span> <span class="hljs-attribute">id</span>=<span class="hljs-value">"myframe"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-title">iframe</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-title">script</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-title">a</span> <span class="hljs-attribute">href</span>=<span class="hljs-value">"#"</span> <span class="hljs-attribute">onclick</span>=<span class="hljs-value">"replaceContent()"</span>&gt;</span>点击替换内容<span class="hljs-tag">&lt;/<span class="hljs-title">a</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-title">script</span> <span class="hljs-attribute">type</span>=<span class="hljs-value">"text/javascript"</span>&gt;</span><span class="javascript">
content = <span class="hljs-string">'我把你的这部分理解成读取一段内容'</span>;
            <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">replaceContent</span><span class="hljs-params">()</span>{</span>
                document.getElementById(<span class="hljs-string">'myframe'</span>).contentWindow.document.body.innerText = content;
            }
document.domain = <span class="hljs-string">"localhost"</span>;
</span><span class="hljs-tag">&lt;/<span class="hljs-title">script</span>&gt;</span>
</code></pre>
<pre class="prettyprint"><code class=" hljs xml"><span class="php"><span class="hljs-preprocessor">&lt;?php</span> 
header(<span class="hljs-string">'Access-Control-Allow-Origin : http://127.0.0.1:8080/'</span>);
<span class="hljs-keyword">echo</span> <span class="hljs-number">222</span>;
<span class="hljs-preprocessor">?&gt;</span></span>
<span class="hljs-doctype">&lt;!DOCTYPE html&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-title">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-title">meta</span> <span class="hljs-attribute">charset</span>=<span class="hljs-value">"utf-8"</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-title">head</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-title">title</span>&gt;</span>测试平台1<span class="hljs-tag">&lt;/<span class="hljs-title">title</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-title">head</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-title">body</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-title">p</span>&gt;</span>hahaha<span class="hljs-tag">&lt;/<span class="hljs-title">p</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-title">p</span>&gt;</span>fuck me<span class="hljs-tag">&lt;/<span class="hljs-title">p</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-title">p</span>&gt;</span>反弹至服务器<span class="hljs-tag">&lt;/<span class="hljs-title">p</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-title">p</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-title">p</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-title">script</span> <span class="hljs-attribute">type</span>=<span class="hljs-value">"text/javascript"</span> &gt;</span><span class="javascript">
document.domain = <span class="hljs-string">"localhost"</span>;
</span><span class="hljs-tag">&lt;/<span class="hljs-title">script</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-title">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-title">html</span>&gt;</span></code></pre></div>